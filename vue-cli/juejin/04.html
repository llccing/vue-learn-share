<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue Learn Share</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="just to it!">
    <link rel="preload" href="/vue-learn-share/assets/css/0.styles.24c1d98d.css" as="style"><link rel="preload" href="/vue-learn-share/assets/js/app.5dfbdd19.js" as="script"><link rel="preload" href="/vue-learn-share/assets/js/2.293d37c1.js" as="script"><link rel="preload" href="/vue-learn-share/assets/js/31.dda26853.js" as="script"><link rel="prefetch" href="/vue-learn-share/assets/js/10.a5f308b2.js"><link rel="prefetch" href="/vue-learn-share/assets/js/11.95e39d02.js"><link rel="prefetch" href="/vue-learn-share/assets/js/12.19fc2075.js"><link rel="prefetch" href="/vue-learn-share/assets/js/13.fcb4bc8f.js"><link rel="prefetch" href="/vue-learn-share/assets/js/14.47780203.js"><link rel="prefetch" href="/vue-learn-share/assets/js/15.6fd95528.js"><link rel="prefetch" href="/vue-learn-share/assets/js/16.df9df609.js"><link rel="prefetch" href="/vue-learn-share/assets/js/17.b73f4b2b.js"><link rel="prefetch" href="/vue-learn-share/assets/js/18.3e545462.js"><link rel="prefetch" href="/vue-learn-share/assets/js/19.58e54c1b.js"><link rel="prefetch" href="/vue-learn-share/assets/js/20.95c6e9f0.js"><link rel="prefetch" href="/vue-learn-share/assets/js/21.21637eff.js"><link rel="prefetch" href="/vue-learn-share/assets/js/22.e915cb41.js"><link rel="prefetch" href="/vue-learn-share/assets/js/23.fe413dd5.js"><link rel="prefetch" href="/vue-learn-share/assets/js/24.3f687092.js"><link rel="prefetch" href="/vue-learn-share/assets/js/25.3b7c0302.js"><link rel="prefetch" href="/vue-learn-share/assets/js/26.f3a1609d.js"><link rel="prefetch" href="/vue-learn-share/assets/js/27.d0c4a232.js"><link rel="prefetch" href="/vue-learn-share/assets/js/28.8ade3387.js"><link rel="prefetch" href="/vue-learn-share/assets/js/29.f18486fe.js"><link rel="prefetch" href="/vue-learn-share/assets/js/3.4166a649.js"><link rel="prefetch" href="/vue-learn-share/assets/js/30.6aaf06b3.js"><link rel="prefetch" href="/vue-learn-share/assets/js/32.02eef993.js"><link rel="prefetch" href="/vue-learn-share/assets/js/33.8e9a7c2a.js"><link rel="prefetch" href="/vue-learn-share/assets/js/34.31e29ea3.js"><link rel="prefetch" href="/vue-learn-share/assets/js/35.dd928ccb.js"><link rel="prefetch" href="/vue-learn-share/assets/js/36.f2b6f2bd.js"><link rel="prefetch" href="/vue-learn-share/assets/js/37.c3c661fa.js"><link rel="prefetch" href="/vue-learn-share/assets/js/38.f218c93c.js"><link rel="prefetch" href="/vue-learn-share/assets/js/39.5124cef8.js"><link rel="prefetch" href="/vue-learn-share/assets/js/4.0c9203a1.js"><link rel="prefetch" href="/vue-learn-share/assets/js/40.024fbe9a.js"><link rel="prefetch" href="/vue-learn-share/assets/js/5.8bd170a4.js"><link rel="prefetch" href="/vue-learn-share/assets/js/6.c93449c5.js"><link rel="prefetch" href="/vue-learn-share/assets/js/7.ee3805c3.js"><link rel="prefetch" href="/vue-learn-share/assets/js/8.5e49085e.js"><link rel="prefetch" href="/vue-learn-share/assets/js/9.c16cb7bd.js">
    <link rel="stylesheet" href="/vue-learn-share/assets/css/0.styles.24c1d98d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-learn-share/" class="home-link router-link-active"><!----> <span class="site-name">Vue Learn Share</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-learn-share/vue-cli/" class="nav-link router-link-active">
  Vue CLI
</a></div><div class="nav-item"><a href="https://llccing.github.io/FrontEnd/about/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/llccing/vue-learn-share" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-learn-share/vue-cli/" class="nav-link router-link-active">
  Vue CLI
</a></div><div class="nav-item"><a href="https://llccing.github.io/FrontEnd/about/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/llccing/vue-learn-share" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/vue-learn-share/vue-cli/" class="sidebar-link">Vue ClI 源码探索</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础命令</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>插件</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/vue-learn-share/vue-cli/19-test.html" class="sidebar-link">TEST</a></li><li><a href="/vue-learn-share/vue-cli/99-cli-shared-utils.html" class="sidebar-link">@vue/cli-shared-utils</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>本系列一共6篇文章</strong></p> <ul><li><a href="https://juejin.im/post/5eba1c2e6fb9a043300c015b" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [开篇]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 整体介绍下 Vue CLI</li> <li><a href="https://juejin.im/post/5eba1e436fb9a0436545b68a" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [一]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> @vue/cli 包的概览，已经第一个命令 vue create</li> <li><a href="https://juejin.im/post/5eba2d69e51d454dcc1fc898" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [二]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 涉及三个命令（vue add/invoke/inspect）</li> <li><a href="https://juejin.im/post/5eba351951882572af0d8322" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [三]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 用的比较多的命令 vue serve/build</li> <li><a href="https://juejin.im/post/5eba35856fb9a0435d138574" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [四]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 其他命令（vue init/outdated/upgrade/migrate/info/<command>/--help）</command></li> <li><a href="https://juejin.im/post/5eba385a6fb9a0435432dd4d" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [五]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 分析下 Vue CLI 中测试相关的内容</li> <li><a href="https://juejin.im/post/5eba39515188256d7e067070" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [六]<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 探索下 Vue CLI 的插件机制，内容较多，请慢慢看。涉及如下插件（@vue/cli-plugin-vuex/router/babel/typescript/eslint）</li></ul> <hr> <p>下面正文开始啦 ^_^</p> <h2 id="vue-init-template-app-name"><a href="#vue-init-template-app-name" class="header-anchor">#</a> vue init template app-name</h2> <p>todo，暂时忽略该命令。一个是因为调试过程中出现报错，第二个是根据我的理解，以后该命令会被废弃。</p> <h3 id="调试配置"><a href="#调试配置" class="header-anchor">#</a> 调试配置</h3> <p>launch.json</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token comment">// 使用 IntelliSense 了解相关属性。 </span>
  <span class="token comment">// 悬停以查看现有属性的描述。</span>
  <span class="token comment">// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387</span>
  <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;启动程序&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;skipFiles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;&lt;node_internals&gt;/**&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// &quot;program&quot;: &quot;${workspaceFolder}/packages/@vue/cli-service/bin/vue-cli-service&quot;,</span>
      <span class="token string">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}/packages/@vue/cli/bin/vue&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;init&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;simple-webapck&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;my-project&quot;</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调试报错</p> <div class="language-js extra-class"><pre class="language-js"><code>vue<span class="token operator">-</span>cli · Failed to download repo vuejs<span class="token operator">-</span>templates<span class="token operator">/</span>simple<span class="token operator">-</span>webapck<span class="token operator">:</span> Response code <span class="token number">404</span> <span class="token punctuation">(</span>Not Found<span class="token punctuation">)</span>
</code></pre></div><h2 id="vue-config-value"><a href="#vue-config-value" class="header-anchor">#</a> vue config [value]</h2> <p>官方介绍：</p> <blockquote><p>有些针对 @vue/cli 的全局配置，例如你惯用的包管理器和你本地保存的 preset，都保存在 home 目录下一个名叫 .vuerc 的 JSON 文件。你可以用编辑器直接编辑这个文件来更改已保存的选项。</p></blockquote> <p>你也可以使用 vue config 命令来审查或修改全局的 CLI 配置。</p> <p>该命令是用来获取或者设置某个配置，这里的配置指的是 <code>/Users/xxxx/.vuerc</code> 这个文件的的配置</p> <p>看下我当前的配置，记录了预设等等</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;useTaobaoRegistry&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;latestVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4.2.3&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;lastChecked&quot;</span><span class="token operator">:</span> <span class="token number">1583721075145</span><span class="token punctuation">,</span>
  <span class="token string">&quot;packageManager&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;llccing-default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;useConfigFiles&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;@vue/cli-plugin-babel&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;@vue/cli-plugin-router&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;historyMode&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;@vue/cli-plugin-eslint&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;config&quot;</span><span class="token operator">:</span> <span class="token string">&quot;base&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;lintOn&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;save&quot;</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;cssPreprocessor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stylus&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="用处"><a href="#用处" class="header-anchor">#</a> 用处</h3> <p>这个config的作用是针对当前计算机中所有项目的通用的config，也就是说是跨项目的。实际开发过程中，感觉使用场景还是比较少。</p> <p>当然我们现在公司的处理方式是用了远程 <code>preset</code> 的方式，然后统一管理这个preset，达到组内所有人都公用一个配置的目的。</p> <p>所以我觉得在企业开发中，<code>.vuerc</code> 中的配置用处还是比较小。</p> <h3 id="调试配置-2"><a href="#调试配置-2" class="header-anchor">#</a> 调试配置</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token comment">// 保留主要部分，其他和前面一致</span>
  <span class="token string">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}/packages/@vucli/bin/vue&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="源码探索"><a href="#源码探索" class="header-anchor">#</a> 源码探索</h3> <p>主要的代码逻辑都在 <code>@vue/cli/lib/config.js</code> 中，也很清晰</p> <ul><li>首先读取 <code>.vuerc</code> 文件</li> <li>如果 <code>vue config</code> 后面没有其他参数，则打印当前的 <code>.vuerc</code> 文件内容</li> <li>然后根据参数类型：<code>get/delete/edit/set</code> 分别操作对应的值</li></ul> <h4 id="vue-config-edit"><a href="#vue-config-edit" class="header-anchor">#</a> vue config edit</h4> <p>在执行这个命令的时候，作者还针对编辑器编辑 <code>.vuerc</code> 文件单独抽象了一个库<a href="https://github.com/yyx990803/launch-editor" target="_blank" rel="noopener noreferrer">launch-editor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>出来，合理的抽象，确实能够降低复杂度，且代码职责解耦，利于维护。</p> <p><strong>解决 edit命令报错的问题</strong>：<a href="https://www.html.cn/archives/10134" target="_blank" rel="noopener noreferrer">将code命令加入 PATH 中<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="有意思的地方"><a href="#有意思的地方" class="header-anchor">#</a> 有意思的地方</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 看了一下这个 os 是node.js内置模块，提供了操作系统相关的使用方法和属性</span>
<span class="token comment">// homedir 返回当前用户的胡目录的字符串格式路径</span>
<span class="token keyword">const</span> homedir <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">homedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>下面再看一段代码，这段代码来自 <code>@vue/cli-shared-utils/lib/object.js</code>，也就是工具库中对象操作的方法，这个方法厉害之处是：如果你想给取得 <code>const obj = {a: {b: {c: { d: 123123, e: '我是eee' } } } }</code>，这个对象中 d 的值，只要执行<code>get(obj, 'a.b.c.d')</code> 即可。</p> <p>假设这样调用<code>get(obj, 'a.b.c.d')</code>，下面分析下逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>
exports<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// fields = ['a', 'b', 'c', 'd']</span>
  <span class="token keyword">const</span> fields <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
  <span class="token comment">// obj = {a: {b: {c: { d: 123123, e: '我是eee' } } } }</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> target
  <span class="token comment">// l = 4</span>
  <span class="token keyword">const</span> l <span class="token operator">=</span> fields<span class="token punctuation">.</span>length
  <span class="token comment">// 通过循环，逐层深入，这里i最大是2</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> fields<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">}</span>
    obj <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// obj = { d: 123123, e: '我是eee' }</span>
  <span class="token comment">// fields[l - 1] = d</span>
  <span class="token comment">// 所以 obj[fields[l - 1]] = obj[d] = 123123</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">[</span>fields<span class="token punctuation">[</span>l <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个写法在vue.js的源码中也能够看到。</p> <h2 id="vue-outdated"><a href="#vue-outdated" class="header-anchor">#</a> vue outdated</h2> <blockquote><p>'(experimental) check for outdated vue cli service / plugins'</p></blockquote> <p>上面是代码中的功能描述原文，我理解这个是说：实验性的功能，用来检查 服务(@vue/cli-service) 或者 插件(官方插件@vue/cli-plugin-* 自定义插件vue-cli-plugin-*) 是否过期</p> <h3 id="调试配置-3"><a href="#调试配置-3" class="header-anchor">#</a> 调试配置</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}/packages/@vue/cli/bin/vue&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;outdated&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的这个调试配置是能够正常执行的，但是有一点缺憾的是，我现在还没有发现如何能能够在某个项目中执行 <code>vue outdated</code> 命令，然后能够在当前的 vue-cli 项目中打断点的方式。</p> <p>所以其中的某些代码逻辑就不能实际执行到，当然这个对我们查看代码会有影响，但是没那么大。</p> <h3 id="源码探索-2"><a href="#源码探索-2" class="header-anchor">#</a> 源码探索</h3> <h4 id="命令注册"><a href="#命令注册" class="header-anchor">#</a> 命令注册</h4> <div class="language-js extra-class"><pre class="language-js"><code>program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'outdated'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'(experimental) check for outdated vue cli service / plugins'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--next'</span><span class="token punctuation">,</span> <span class="token string">'Also check for alpha / beta / rc versions when upgrading'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/outdated'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">cleanArgs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="主要逻辑"><a href="#主要逻辑" class="header-anchor">#</a> 主要逻辑</h4> <p><code>@vue/cli/lib/outdated.js</code> 这个文件中也很清晰，加载 <code>./Upgrader</code> 类，实例化，调用 <code>checkForUpdates</code> 方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Upgrader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Upgrader'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">outdated</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> context <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> upgrader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upgrader</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token keyword">return</span> upgrader<span class="token punctuation">.</span><span class="token function">checkForUpdates</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先 <code>Upgrader</code> 实例化时，构造函数中初始了两个属性，并且又实例化了 PackageManager 类。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>pkg <span class="token operator">=</span> <span class="token function">getPkg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>pm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PackageManager</span><span class="token punctuation">(</span><span class="token punctuation">{</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这个 PackageManager 类我们可以通过他的方法来大致了解他的作用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">PackageManager</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">runCommand</span> <span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">add</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>packageName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">packageName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>packageName<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">upgrade</span> <span class="token punctuation">(</span><span class="token parameter">packageName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runCommand</span><span class="token punctuation">(</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>packageName<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主要是针对依赖包的处理，安装、添加、移除、升级，版本比较等。</p> <p>下面看下这个方法，因为要做版本比较，所以需要有比较的源 -- 也就是最新版本。<code>getRemoteVersion</code> 这个方法是用来获取远程版本的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getRemoteVersion</span> <span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> versionRange <span class="token operator">=</span> <span class="token string">'latest'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> metadata <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span>packageName<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>metadata<span class="token punctuation">[</span><span class="token string">'dist-tags'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>versionRange<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里判断如果版本匹配，则和就直接返回版本号</span>
    <span class="token keyword">return</span> metadata<span class="token punctuation">[</span><span class="token string">'dist-tags'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>versionRange<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> versions <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>versions<span class="token punctuation">)</span> <span class="token operator">?</span> metadata<span class="token punctuation">.</span>versions <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>versions<span class="token punctuation">)</span>
  <span class="token comment">// 然后这里返回所有匹配的版本中，最大的版本。</span>
  <span class="token keyword">return</span> semver<span class="token punctuation">.</span><span class="token function">maxSatisfying</span><span class="token punctuation">(</span>versions<span class="token punctuation">,</span> versionRange<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中的 <code>this.getMetadata(packageName)</code> 这个方法的内容可以看下，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>registry<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 请求url，url类似这样 http://npm.intra.xiaojukeji.com/@vue/cli</span>
  metadata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>body
  metadataCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>metadataKey<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span>
  <span class="token keyword">return</span> metadata
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to get response from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">throw</span> e
<span class="token punctuation">}</span>
</code></pre></div><p>我通过curl的方式模仿request请求，<code>curl http://npm.intra.xiaojukeji.com/@vue/cli</code> 拿到的返回结果如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;_id&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;@vue/cli&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;_rev&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;45453609&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;@vue/cli&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Command line interface for rapid Vue.js development&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;dist-tags&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;next&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;4.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;latest&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;4.2.3&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">&quot;versions&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;4.1.1&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;@vue/cli&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;description&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Command line interface for rapid Vue.js development&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;version&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;4.1.1&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;author&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;Evan You&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;4.1.2&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来再看 <code>checkForUpdates</code> 方法，首先是获取当前项目依赖中的 <code>if (name !== '@vue/cli-service' &amp;&amp; !isPlugin(name))</code> 主要是找服务和插件，其中 isPlugin 这个方法尤其值得好好品一下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> pluginRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(@vue\/|vue-|@[\w-]+(\.)?[\w-]+\/vue-)cli-plugin-</span><span class="token regex-delimiter">/</span></span>
exports<span class="token punctuation">.</span><span class="token function-variable function">isPlugin</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=&gt;</span> pluginRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
</code></pre></div><p>看到这个正则我只能空叹：“厉害！”，当然我们大致可以理解是匹配了名字来判断是否为插件。</p> <p>获取到需要过期的插件后，通过控制台输出，从而提示用户进行升级。</p> <h2 id="vue-upgrade-plugin-name"><a href="#vue-upgrade-plugin-name" class="header-anchor">#</a> vue upgrade [plugin-name]</h2> <blockquote><p>引用原文：(experimental) upgrade vue cli service / plugins</p></blockquote> <p>这个是用来升级 cli-service 和 plugins 的。</p> <h3 id="源码探索-3"><a href="#源码探索-3" class="header-anchor">#</a> 源码探索</h3> <h4 id="调试脚本"><a href="#调试脚本" class="header-anchor">#</a> 调试脚本</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}/packages/@vue/cli/bin/vue&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;upgrade&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;@vue/cli-service&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="命令注册-2"><a href="#命令注册-2" class="header-anchor">#</a> 命令注册</h4> <div class="language-js extra-class"><pre class="language-js"><code>program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'upgrade [plugin-name]'</span><span class="token punctuation">)</span>
  <span class="token comment">// 这也是个实验性的功能</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'(experimental) upgrade vue cli service / plugins'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-t, --to &lt;version&gt;'</span><span class="token punctuation">,</span> <span class="token string">'Upgrade &lt;package-name&gt; to a version that is not latest'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-f, --from &lt;version&gt;'</span><span class="token punctuation">,</span> <span class="token string">'Skip probing installed plugin, assuming it is upgraded from the designated version'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-r, --registry &lt;url&gt;'</span><span class="token punctuation">,</span> <span class="token string">'Use specified npm registry when installing dependencies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--all'</span><span class="token punctuation">,</span> <span class="token string">'Upgrade all plugins'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--next'</span><span class="token punctuation">,</span> <span class="token string">'Also check for alpha / beta / rc versions when upgrading'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">packageName<span class="token punctuation">,</span> cmd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/upgrade'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> <span class="token function">cleanArgs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>代码的主要逻辑在 <code>@vue/cli/lib/upgrade.js</code> 这个文件中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">upgrade</span> <span class="token punctuation">(</span><span class="token parameter">packageName<span class="token punctuation">,</span> options<span class="token punctuation">,</span> context <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 首先校验了项目目录下是否有代码没有提交</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">confirmIfGitDirty</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 然后实例化了 `Upgrader` 类</span>
  <span class="token keyword">const</span> upgrader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upgrader</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
  <span class="token comment">// 如果没指定具体的升级包</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Must specify a package name to upgrade to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>to<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>all<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> upgrader<span class="token punctuation">.</span><span class="token function">upgradeAll</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过 `const upgradable = await upgrader.checkForUpdates(options.next)` 检查是否有更新，</span>
    <span class="token keyword">const</span> upgradable <span class="token operator">=</span> <span class="token keyword">await</span> upgrader<span class="token punctuation">.</span><span class="token function">checkForUpdates</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> ok <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'ok'</span><span class="token punctuation">,</span>
          type<span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
          message<span class="token operator">:</span> <span class="token string">'Continue to upgrade these plugins?'</span><span class="token punctuation">,</span>
          <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> upgrader<span class="token punctuation">.</span><span class="token function">upgradeAll</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果指定了升级的包，那么直接升级就好</span>
  <span class="token keyword">return</span> upgrader<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>git status --porcelain</code> 命令检查当前仓库中是否有未提交的内容（也就是看git的工作区和暂存区是否有新的内容）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> stdout <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">execa</span><span class="token punctuation">(</span><span class="token string">'git'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'status'</span><span class="token punctuation">,</span> <span class="token string">'--porcelain'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stdout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>@vue/cli/lib/Upgrader.js</code> 这里我们看下 <code>Upgrader</code> 类的 <code>upgrade</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">upgrade</span> <span class="token punctuation">(</span><span class="token parameter">pluginId<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token comment">// 这里是说如果要升级的包存在 migrator（升级器）则调用它</span>
  <span class="token keyword">const</span> pluginMigrator <span class="token operator">=</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/migrator</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span> <span class="token operator">||</span> noop

  <span class="token keyword">await</span> <span class="token function">runMigrator</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        id<span class="token operator">:</span> packageName<span class="token punctuation">,</span>
        apply<span class="token operator">:</span> pluginMigrator<span class="token punctuation">,</span>
        baseVersion<span class="token operator">:</span> installed
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pkg
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>runMigrator</code> 来自 <code>@vue/cli/lib/migrate.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runMigrator</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> plugin<span class="token punctuation">,</span> pkg <span class="token operator">=</span> <span class="token function">getPkg</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> afterInvokeCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 这里实例化了迁移器</span>
  <span class="token keyword">const</span> migrator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Migrator</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    plugin<span class="token punctuation">,</span>
    pkg<span class="token punctuation">,</span>
    files<span class="token operator">:</span> <span class="token keyword">await</span> <span class="token function">readFiles</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>
    afterInvokeCbs
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">await</span> migrator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extractConfigFiles<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    checkExisting<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看下 <code>Migrator</code> 的真面目，<code>@vue/cli/lib/Migrator.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里 Migrator 继承了 Generator，所以可以使用 Generator 的方法</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Migrator</span> <span class="token keyword">extends</span> <span class="token class-name">Generator</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 这里是对原有方法的覆盖</span>
  <span class="token keyword">async</span> <span class="token function">generate</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>migratorPlugin

    <span class="token comment">// apply migrators from plugins</span>
    <span class="token comment">// 调用插件的 migrator</span>
    <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MigratorAPI</span><span class="token punctuation">(</span>
      plugin<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      plugin<span class="token punctuation">.</span>baseVersion<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">,</span>
      plugin<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rootOptions
    <span class="token punctuation">)</span>

    <span class="token comment">// 这里是调用了 插件中的 migrator 方法</span>
    <span class="token keyword">await</span> <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rootOptions<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoking<span class="token punctuation">)</span>

    <span class="token comment">// 这里仍然调用父类的方法</span>
    <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们看上面实例化了 <code>MigratorAPI</code>，我们看下他的本来面目 <code>@vue/cli/lib/MigratorAPI</code> ：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MigratorAPI</span> <span class="token keyword">extends</span> <span class="token class-name">GeneratorAPI</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * @param {string} id - Id of the owner plugin
   * @param {Migrator} migrator - The invoking Migrator instance
   * @param {object} options - options passed to this plugin
   * @param {object} rootOptions - root options (the entire preset)
   */</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> baseVersion<span class="token punctuation">,</span> migrator<span class="token punctuation">,</span> options<span class="token punctuation">,</span> rootOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> migrator<span class="token punctuation">,</span> options<span class="token punctuation">,</span> rootOptions<span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>baseVersion <span class="token operator">=</span> baseVersion
    <span class="token keyword">this</span><span class="token punctuation">.</span>migrator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>generator
  <span class="token punctuation">}</span>

  <span class="token function">fromVersion</span> <span class="token punctuation">(</span><span class="token parameter">range</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> semver<span class="token punctuation">.</span><span class="token function">satisfies</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>baseVersion<span class="token punctuation">,</span> range<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>MigratorAPI</code> 继承了 <code>GeneratorAPI</code>，所以她就拥有了 <code>GeneratorAPI</code> 所有的方法</p> <h2 id="vue-migrate-plugin-name"><a href="#vue-migrate-plugin-name" class="header-anchor">#</a> vue migrate [plugin-name]</h2> <blockquote><p>(experimental) run migrator for an already-installed cli plugin</p></blockquote> <p>实验的功能，用于迁移已经安装的插件</p> <h3 id="源码探索-4"><a href="#源码探索-4" class="header-anchor">#</a> 源码探索</h3> <h4 id="命令注册-3"><a href="#命令注册-3" class="header-anchor">#</a> 命令注册</h4> <div class="language-js extra-class"><pre class="language-js"><code>program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'migrate [plugin-name]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'(experimental) run migrator for an already-installed cli plugin'</span><span class="token punctuation">)</span>
  <span class="token comment">// TODO: use `requiredOption` after upgrading to commander 4.x</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'-f, --from &lt;version&gt;'</span><span class="token punctuation">,</span> <span class="token string">'The base version for the migrator to migrate from'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">packageName<span class="token punctuation">,</span> cmd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/migrate'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> <span class="token function">cleanArgs</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="调试配置-4"><a href="#调试配置-4" class="header-anchor">#</a> 调试配置</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;program&quot;</span><span class="token operator">:</span> <span class="token string">&quot;${workspaceFolder}/packages/@vue/cli/bin/vue&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;migrate&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;@vue/cli-service&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;--from=4.2.1&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="逻辑"><a href="#逻辑" class="header-anchor">#</a> 逻辑</h4> <p>主要的逻辑从 <code>@vue/cli/lib/migrate.js</code> 开始</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">migrate</span> <span class="token punctuation">(</span><span class="token parameter">pluginId<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">from</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> context <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO: remove this after upgrading to commander 4.x</span>
  <span class="token comment">// 这里会强制设置迁移的基础版本</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">from</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Required option 'from' not specified</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> pluginName <span class="token operator">=</span> <span class="token function">resolvePluginId</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">)</span>
  <span class="token comment">// 这里是载入了插件的 migrator 文件，留给插件开发者迁移入口，具体的迁移逻辑有插件开发者实现。</span>
  <span class="token keyword">const</span> pluginMigrator <span class="token operator">=</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/migrator</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pluginMigrator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">There's no migrator in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> <span class="token function">runMigrator</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> pluginName<span class="token punctuation">,</span>
    apply<span class="token operator">:</span> pluginMigrator<span class="token punctuation">,</span>
    baseVersion<span class="token operator">:</span> <span class="token keyword">from</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再看下 <code>runMigrator</code> 方法，实例化了 <code>Migrator</code> 类，而 <code>Migtrator</code> 类则继承了 <code>Generator</code> 类并且重写了 <code>generate</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">async</span> <span class="token function">generate</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>migratorPlugin

    <span class="token comment">// apply migrators from plugins</span>
    <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MigratorAPI</span><span class="token punctuation">(</span>
      plugin<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      plugin<span class="token punctuation">.</span>baseVersion<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">,</span>
      plugin<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rootOptions
    <span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rootOptions<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>invoking<span class="token punctuation">)</span>

    <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>其中 <code>MigratorAPI</code> 是继承了 <code>GeneratorAPI</code>。</p> <p><strong>TODO</strong> 这一段的代码是的设计是很精巧的，<code>Generator</code>/<code>GeneratorAPI</code>/<code>Migrator</code>/<code>MigratorAPI</code>，并且 <code>Migrator</code> 继承 <code>Generator</code>，<code>MigratorAPI</code> 继承 <code>GeneratorAPI</code>，总觉这里是应用了一种或者多多种设计模式，但是现在还没想清晰，先留个疑问在此。</p> <p>我们再看 <code>runMigrator</code> 的后续逻辑，执行 <code>migrator</code> 实例的 <code>generate</code> 方法，同时如果有新的依赖则通过 pm（<code>PackageManager</code> 实例）安装，如果有钩子函数则执行钩子函数，然后通过 <code>git ls-files -o --exclude-standard --full-name</code> 命令识别出本次迁移变化的内容，提醒用户关注这些文件变化。</p> <h2 id="vue-info"><a href="#vue-info" class="header-anchor">#</a> vue info</h2> <blockquote><p>print debugging information about your environment</p></blockquote> <p>打印当前环境的调试信息</p> <h3 id="源码探索-5"><a href="#源码探索-5" class="header-anchor">#</a> 源码探索</h3> <div class="language-js extra-class"><pre class="language-js"><code>program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">description</span><span class="token punctuation">(</span><span class="token string">'print debugging information about your environment'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">bold</span><span class="token punctuation">(</span><span class="token string">'\nEnvironment Info:'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'envinfo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        System<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'OS'</span><span class="token punctuation">,</span> <span class="token string">'CPU'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        Binaries<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Node'</span><span class="token punctuation">,</span> <span class="token string">'Yarn'</span><span class="token punctuation">,</span> <span class="token string">'npm'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        Browsers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Chrome'</span><span class="token punctuation">,</span> <span class="token string">'Edge'</span><span class="token punctuation">,</span> <span class="token string">'Firefox'</span><span class="token punctuation">,</span> <span class="token string">'Safari'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        npmPackages<span class="token operator">:</span> <span class="token string">'/**/{typescript,*vue*,@vue/*/}'</span><span class="token punctuation">,</span>
        npmGlobalPackages<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@vue/cli'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        showNotFound<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        duplicates<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        fullTree<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里主要是依赖了 <a href="https://github.com/tabrindle/envinfo" target="_blank" rel="noopener noreferrer">envinfo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的能力。</p> <p>这里看一下我当前环境的信息，只所以 <code>@vue/cli: Not Found</code> 这个是因为我当前是调试模式，在@vue/cli目录执行了 <code>yarn link</code>，所以这里的 <code>@vue/cli</code> 是 Not Found</p> <div class="language- extra-class"><pre class="language-text"><code>Environment Info:

  System:
    OS: macOS Sierra 10.12.6
    CPU: (4) x64 Intel(R) Core(TM) i5-7360U CPU @ 2.30GHz
  Binaries:
    Node: 12.13.0 - ~/.nvm/versions/node/v12.13.0/bin/node
    Yarn: 1.22.0 - ~/.yarn/bin/yarn
    npm: 6.12.0 - ~/.nvm/versions/node/v12.13.0/bin/npm
  Browsers:
    Chrome: 80.0.3987.149
    Firefox: 72.0.1
    Safari: 12.1.2
  npmPackages:
    @vue/babel-helper-vue-jsx-merge-props:  1.0.0
    @vue/babel-plugin-transform-vue-jsx:  1.0.0
    @vue/babel-preset-app:  3.11.0
    @vue/babel-preset-jsx:  1.1.0
    @vue/babel-sugar-functional-vue:  1.0.0
    @vue/babel-sugar-inject-h:  1.0.0
    @vue/babel-sugar-v-model:  1.0.0
    @vue/babel-sugar-v-on:  1.1.0
    @vue/component-compiler-utils:  3.0.0
    vue:  2.6.10
    vue-hot-reload-api:  2.3.4
    vue-loader:  15.7.1
    vue-router:  3.1.3
    vue-server-renderer:  2.6.10
    vue-style-loader:  4.1.2
    vue-template-compiler:  2.6.10
    vue-template-es2015-compiler:  1.9.1
    vuepress: ^1.1.0 =&gt; 1.1.0
    vuepress-html-webpack-plugin:  3.2.0
    vuepress-plugin-container:  2.0.2
  npmGlobalPackages:
    @vue/cli: Not Found

</code></pre></div><h2 id="vue-command"><a href="#vue-command" class="header-anchor">#</a> <code>vue &lt;command&gt;</code></h2> <blockquote><p>output help information on unknown commands</p></blockquote> <p>主要是针对没有设置的命令，输出帮助信息</p> <div class="language-js extra-class"><pre class="language-js"><code>program
  <span class="token punctuation">.</span><span class="token function">arguments</span><span class="token punctuation">(</span><span class="token string">'&lt;command&gt;'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    program<span class="token punctuation">.</span><span class="token function">outputHelp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unknown command </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 这个建议命令是个人性化的功能，如果你不小心输错一个字符，他会提示你正确的</span>
    <span class="token function">suggestCommands</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们看下 <code>suggestCommands</code> 的代码</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">function</span> <span class="token function">suggestCommands</span> <span class="token punctuation">(</span><span class="token parameter">unknownCommand</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 取得所有注册命令</span>
  <span class="token keyword">const</span> availableCommands <span class="token operator">=</span> program<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> cmd<span class="token punctuation">.</span>_name<span class="token punctuation">)</span>

  <span class="token keyword">let</span> suggestion

  availableCommands<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cmd</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    举个拼配的例子
    实际输入值 bast
    ''   leven 4
    计划输入值 best leven 1
    这样的情况下，isBestMatch = true
    */</span>
    <span class="token keyword">const</span> isBestMatch <span class="token operator">=</span> <span class="token function">leven</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> unknownCommand<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">leven</span><span class="token punctuation">(</span>suggestion <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span> unknownCommand<span class="token punctuation">)</span>
    <span class="token comment">// 如果拼配不上的字符数 &lt; 3 并且 isBestMatch=true 则说明找到了 “建议命令”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">leven</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> unknownCommand<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> isBestMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      suggestion <span class="token operator">=</span> cmd
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>suggestion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Did you mean </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>suggestion<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://github.com/sindresorhus/leven" target="_blank" rel="noopener noreferrer">leven<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> README中作者这样描述：测量两个不同的字符串的差别，实现莱温斯坦距离算法最快的js实现，没有之一...，说明很有信心的！</p> <h2 id="vue-help"><a href="#vue-help" class="header-anchor">#</a> vue --help</h2> <p>help 主要是为了输出帮助信息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// add some useful info on help</span>
program<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'--help'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  Run </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue &lt;command&gt; --help</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> for detailed usage of given command.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 这个循环是给每一个命令都自定义了帮助信息</span>
program<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'--help'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><p>至此，@vue/cli/bin 中涉及的15个命令就都过了一遍，相信你和我一样都有收获。</p> <h2 id="感谢阅读"><a href="#感谢阅读" class="header-anchor">#</a> 感谢阅读</h2> <blockquote><p><a href="https://llccing.github.io/vue-learn-share/vue-cli/" target="_blank" rel="noopener noreferrer">原文地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>感谢你阅读到这里，翻译的不好的地方，还请指点。希望我的内容能让你受用，再次感谢。<a href="https://llccing.github.io/FrontEnd/" target="_blank" rel="noopener noreferrer">by llccing 千里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2020-05-12 14:17:00</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vue-learn-share/assets/js/app.5dfbdd19.js" defer></script><script src="/vue-learn-share/assets/js/2.293d37c1.js" defer></script><script src="/vue-learn-share/assets/js/31.dda26853.js" defer></script>
  </body>
</html>
