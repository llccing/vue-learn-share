<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue Learn Share</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="just to it!">
    
    <link rel="preload" href="/vue-learn-share/assets/css/0.styles.c7bf14b5.css" as="style"><link rel="preload" href="/vue-learn-share/assets/js/app.ac9fac58.js" as="script"><link rel="preload" href="/vue-learn-share/assets/js/2.7048fe21.js" as="script"><link rel="preload" href="/vue-learn-share/assets/js/35.97b599d7.js" as="script"><link rel="prefetch" href="/vue-learn-share/assets/js/10.d5048b08.js"><link rel="prefetch" href="/vue-learn-share/assets/js/11.7d4c3a82.js"><link rel="prefetch" href="/vue-learn-share/assets/js/12.b519a5df.js"><link rel="prefetch" href="/vue-learn-share/assets/js/13.a7922097.js"><link rel="prefetch" href="/vue-learn-share/assets/js/14.591f733c.js"><link rel="prefetch" href="/vue-learn-share/assets/js/15.ee2e9dcd.js"><link rel="prefetch" href="/vue-learn-share/assets/js/16.4a394b75.js"><link rel="prefetch" href="/vue-learn-share/assets/js/17.340d01ed.js"><link rel="prefetch" href="/vue-learn-share/assets/js/18.a39e266c.js"><link rel="prefetch" href="/vue-learn-share/assets/js/19.5006785b.js"><link rel="prefetch" href="/vue-learn-share/assets/js/20.e03f6b4d.js"><link rel="prefetch" href="/vue-learn-share/assets/js/21.2701e290.js"><link rel="prefetch" href="/vue-learn-share/assets/js/22.3b6e8236.js"><link rel="prefetch" href="/vue-learn-share/assets/js/23.1ee36544.js"><link rel="prefetch" href="/vue-learn-share/assets/js/24.8378267d.js"><link rel="prefetch" href="/vue-learn-share/assets/js/25.9a84d0dc.js"><link rel="prefetch" href="/vue-learn-share/assets/js/26.a8c55c94.js"><link rel="prefetch" href="/vue-learn-share/assets/js/27.29e3620b.js"><link rel="prefetch" href="/vue-learn-share/assets/js/28.93db7fe4.js"><link rel="prefetch" href="/vue-learn-share/assets/js/29.b60f49f3.js"><link rel="prefetch" href="/vue-learn-share/assets/js/3.f63fe382.js"><link rel="prefetch" href="/vue-learn-share/assets/js/30.7d957bf6.js"><link rel="prefetch" href="/vue-learn-share/assets/js/31.5f6a3d7f.js"><link rel="prefetch" href="/vue-learn-share/assets/js/32.76a78139.js"><link rel="prefetch" href="/vue-learn-share/assets/js/33.f900103c.js"><link rel="prefetch" href="/vue-learn-share/assets/js/34.b2a0cfa5.js"><link rel="prefetch" href="/vue-learn-share/assets/js/36.1d212fa1.js"><link rel="prefetch" href="/vue-learn-share/assets/js/37.ad85dfbd.js"><link rel="prefetch" href="/vue-learn-share/assets/js/38.3eb8c877.js"><link rel="prefetch" href="/vue-learn-share/assets/js/39.0eb68b96.js"><link rel="prefetch" href="/vue-learn-share/assets/js/4.d35a5c6a.js"><link rel="prefetch" href="/vue-learn-share/assets/js/40.3ca0a818.js"><link rel="prefetch" href="/vue-learn-share/assets/js/41.09c0efdf.js"><link rel="prefetch" href="/vue-learn-share/assets/js/5.e68c2a2f.js"><link rel="prefetch" href="/vue-learn-share/assets/js/6.9dbebde6.js"><link rel="prefetch" href="/vue-learn-share/assets/js/7.6aed578e.js"><link rel="prefetch" href="/vue-learn-share/assets/js/8.404c26a7.js"><link rel="prefetch" href="/vue-learn-share/assets/js/9.f90b9765.js">
    <link rel="stylesheet" href="/vue-learn-share/assets/css/0.styles.c7bf14b5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-learn-share/" class="home-link router-link-active"><!----> <span class="site-name">Vue Learn Share</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-learn-share/vue-cli/" class="nav-link router-link-active">
  Vue CLI
</a></div><div class="nav-item"><a href="https://llccing.github.io/FrontEnd/about/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/llccing/vue-learn-share" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-learn-share/vue-cli/" class="nav-link router-link-active">
  Vue CLI
</a></div><div class="nav-item"><a href="https://llccing.github.io/FrontEnd/about/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  About
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/llccing/vue-learn-share" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/vue-learn-share/vue-cli/" aria-current="page" class="sidebar-link">Vue ClI 源码探索</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础命令</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>插件</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/vue-learn-share/vue-cli/19-test.html" class="sidebar-link">TEST</a></li><li><a href="/vue-learn-share/vue-cli/99-cli-shared-utils.html" class="sidebar-link">@vue/cli-shared-utils</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><strong>本系列一共6篇文章</strong></p> <ul><li><a href="https://juejin.im/post/5eba1c2e6fb9a043300c015b" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [开篇]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 整体介绍下 Vue CLI</li> <li><a href="https://juejin.im/post/5eba1e436fb9a0436545b68a" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [一]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> @vue/cli 包的概览，已经第一个命令 vue create</li> <li><a href="https://juejin.im/post/5eba2d69e51d454dcc1fc898" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [二]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 涉及三个命令（vue add/invoke/inspect）</li> <li><a href="https://juejin.im/post/5eba351951882572af0d8322" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [三]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用的比较多的命令 vue serve/build</li> <li><a href="https://juejin.im/post/5eba35856fb9a0435d138574" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [四]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 其他命令（vue init/outdated/upgrade/migrate/info/<command>/--help）</command></li> <li><a href="https://juejin.im/post/5eba385a6fb9a0435432dd4d" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [五]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 分析下 Vue CLI 中测试相关的内容</li> <li><a href="https://juejin.im/post/5eba39515188256d7e067070" target="_blank" rel="noopener noreferrer">Vue CLI 源码探索 [六]<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 探索下 Vue CLI 的插件机制，内容较多，请慢慢看。涉及如下插件（@vue/cli-plugin-vuex/router/babel/typescript/eslint）</li></ul> <hr> <p>下面正文开始啦 ^_^</p> <h1 id="plugin-插件"><a href="#plugin-插件" class="header-anchor">#</a> plugin 插件</h1> <p><strong>组件化：</strong></p> <p>台式电脑可以分为三部分，显示器、主机、键鼠，主机，内部再次拆分为主板、电源、硬盘、内存条等等部分。每一个部分是自闭和的整体，我理解这就是一种组件化的方式。</p> <p><strong>插件化：</strong></p> <p>主板上有很多<a href="https://zh.wikipedia.org/wiki/%E5%A4%96%E8%AE%BE%E7%BB%84%E4%BB%B6%E4%BA%92%E8%BF%9E%E6%A0%87%E5%87%86" target="_blank" rel="noopener noreferrer">PCI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，这些插槽可以查很多东西，来丰富电脑的功能，比如：网卡、声卡、电视卡、硬盘控制器等等许多东西，那么你说没有拆件电脑能够启动吗，当然只不过有些功能不能实现，比如上网、听音与。插件化就是这种道理，通过丰富的插件简化Vue开发，是你专注于业务逻辑，同时通过官方插件构建的项目也是最佳实践。当然也支持自定义插件，按照统一的插件开发方式写出的插件就能够适配所有 Vue/cli 创建的项目。</p> <h2 id="插件组成"><a href="#插件组成" class="header-anchor">#</a> 插件组成</h2> <p>首先我们头脑中需要有一个插件的整体概念，由哪些部分组成：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">.</span>
├── README.md
├── generator.js  <span class="token comment"># generator（可选）</span>
├── index.js      <span class="token comment"># service 插件</span>
├── package.json
├── prompts.js    <span class="token comment"># prompt 文件（可选）</span>
└── ui.js         <span class="token comment"># Vue UI 集成（可选）</span>
</code></pre></div><h2 id="安装并执行插件"><a href="#安装并执行插件" class="header-anchor">#</a> 安装并执行插件</h2> <p><code>vue add [plugin]</code>，这个命令我们已经在<a href="https://llccing.github.io/FrontEnd/lib/vue-cli/04-cli-add.html" target="_blank" rel="noopener noreferrer">前面<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>讲过了。</p> <p>插件包函几部分中，<code>generator</code> 和 <code>prompts</code> 是在 <code>vue add</code> 命令执行的时候执行的。</p> <p><code>service</code> 插件的执行时机则是在运行 <code>vue-cli-service xxx</code> 命令时，如 <code>vue-cli-service serve</code>，得出这个结论可以看下 <code>@vue/cli-service/lib/Service.js</code> 的 <code>init</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// apply plugins.</span>
    <span class="token comment">// this.plugins 就是当前项目中的全部 Vue CLI 插件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id<span class="token punctuation">,</span> apply <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pluginsToSkip<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token comment">// apply 方法就是 插件中 Service 默认导出的函数</span>
      <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PluginAPI</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectOptions<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>至于为什么 <code>vue-cli-service serve</code> 最终会走到上面的 <code>init</code> 方法，我们在之前在 <a href="https://llccing.github.io/FrontEnd/lib/vue-cli/06-cli-inspect.html" target="_blank" rel="noopener noreferrer">探索 vue inspect<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 时提到过的。</p> <h2 id="插件列表"><a href="#插件列表" class="header-anchor">#</a> 插件列表</h2> <p><strong>官方插件</strong></p> <ul><li>@vue/cli-plugin-vuex</li> <li>@vue/cli-plugin-router</li> <li>@vue/cli-plugin-typescript</li> <li>@vue/cli-plugin-eslint</li> <li>@vue/cli-plugin-babel</li> <li>@vue/cli-plugin-pwa</li> <li>@vue/cli-plugin-unit-jest</li> <li>@vue/cli-plugin-unit-mocha</li> <li>@vue/cli-plugin-e2e-cypress</li> <li>@vue/cli-plugin-e2e-nightwatch</li></ul> <h2 id="todo"><a href="#todo" class="header-anchor">#</a> TODO</h2> <ul class="contains-task-list"><li class="task-list-item"><input checked="checked" disabled="disabled" type="checkbox" class="task-list-item-checkbox"> 翻译 <a href="https://cli.vuejs.org/dev-guide/plugin-dev.html" target="_blank" rel="noopener noreferrer">plugin-dev<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 文档</li> <li class="task-list-item"><input checked="checked" disabled="disabled" type="checkbox" class="task-list-item-checkbox"> @vue/cli-plugin-vuex</li> <li class="task-list-item"><input checked="checked" disabled="disabled" type="checkbox" class="task-list-item-checkbox"> @vue/cli-plugin-router</li> <li class="task-list-item"><input checked="checked" disabled="disabled" type="checkbox" class="task-list-item-checkbox"> @vue/cli-plugin-babel</li> <li class="task-list-item"><input checked="checked" disabled="disabled" type="checkbox" class="task-list-item-checkbox"> @vue/cli-plugin-typescript</li> <li class="task-list-item"><input checked="checked" disabled="disabled" type="checkbox" class="task-list-item-checkbox"> @vue/cli-plugin-eslint</li></ul> <p>使用Markdown语法来写 todo list 还有个小插曲：<a href="https://github.com/vuejs/vuepress/issues/986" target="_blank" rel="noopener noreferrer">不展示 todo list的原因见此<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="插件开发"><a href="#插件开发" class="header-anchor">#</a> 插件开发</h2> <p>插件开发部分的文档可以见我<a href="https://llccing.github.io/FrontEnd/blog/translate/vue-cli-plugin-dev.html" target="_blank" rel="noopener noreferrer">翻译的内容<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，相信会对你有所帮助。</p> <h2 id="webpack-loader"><a href="#webpack-loader" class="header-anchor">#</a> webpack loader</h2> <ul><li><a href="https://github.com/vuejs/vue-loader" target="_blank" rel="noopener noreferrer">vue-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Vue.js 对应 webpack loader</li> <li><a href="https://github.com/babel/babel-loader" target="_blank" rel="noopener noreferrer">babel-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 就是那个很厉害的工具对应的 webpack 插件</li> <li><a href="https://github.com/webpack-contrib/thread-loader" target="_blank" rel="noopener noreferrer">thread-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在一个工作池中运行接下来的 loader</li> <li><a href="https://github.com/webpack-contrib/cache-loader" target="_blank" rel="noopener noreferrer">cache-loader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在磁盘中缓存接下来的 loader</li></ul> <h2 id="webpack-plugin"><a href="#webpack-plugin" class="header-anchor">#</a> webpack plugin</h2> <ul><li><a href="https://github.com/TypeStrong/fork-ts-checker-webpack-plugin" target="_blank" rel="noopener noreferrer">fork-ts-checker-webpack-plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在单独的进程中运行 typescirpt 类型检查器</li></ul> <h1 id="vue-cli-plugin-vuex"><a href="#vue-cli-plugin-vuex" class="header-anchor">#</a> @vue/cli-plugin-vuex</h1> <p>这个插件是从 <code>@vue/cli@4.x</code> 开始增加的，规范化 vuex 的使用，同时提供更加完美的默认配置。</p> <h2 id="源码探索"><a href="#源码探索" class="header-anchor">#</a> 源码探索</h2> <p>cli-plugin-vuex 插件由两个部分组成，Service 和 Generator。</p> <h3 id="service-部分"><a href="#service-部分" class="header-anchor">#</a> Service 部分</h3> <p>一是必须有的 Service 部分：从 <code>package.json</code> 文件中可以看到，主文件是根目录的 <code>index.js</code>，文件内容如下</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>可以看到这里返回了一个空函数，这个是根据这个<a href="https://cli.vuejs.org/dev-guide/plugin-dev.html#service-plugin" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来的。</p> <h3 id="generator-部分"><a href="#generator-部分" class="header-anchor">#</a> Generator 部分</h3> <p>还有一部分是 <code>Generator</code>，就是 <code>/generator/index.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里的 api 指的是 GeneratorAPI 实例</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里 api.entryFile 指的是 main.js 文件</span>
  api<span class="token punctuation">.</span><span class="token function">injectImports</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import store from './store'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  api<span class="token punctuation">.</span><span class="token function">injectRootOptions</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">store</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      vuex<span class="token operator">:</span> <span class="token string">'^3.1.2'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  api<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./template'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 这里指的是 GeneratorAPI 被调用的过程中，如果是 typescript 项目的需要做转换</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span>invoking <span class="token operator">&amp;&amp;</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* eslint-disable-next-line node/no-extraneous-require */</span>
    <span class="token keyword">const</span> convertFiles <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-plugin-typescript/generator/convert'</span><span class="token punctuation">)</span>
    <span class="token function">convertFiles</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>api.entryFile</code> 你可能好奇他到底只的是哪个文件，我们看这里：</p> <p><code>@vue/cli/lib/GeneratorAPI.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * Get the entry file taking into account typescript.
   *
   * @readonly
   */</span>
  <span class="token keyword">get</span> <span class="token function">entryFile</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_entryFile<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_entryFile
    <span class="token comment">// 从这里可以看到，它就是指的 主文件</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_entryFile <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/main.ts'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'src/main.ts'</span> <span class="token operator">:</span> <span class="token string">'src/main.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>再看下 <code>injectImports</code> 这个方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 添加导入语句到文件中
   * 在这里 file 指的是主文件
   * imports 就是导入语句
   */</span>
  <span class="token function">injectImports</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> imports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _imports <span class="token operator">=</span> <span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>imports<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>imports<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// imports 这里是支持数组的，非数组也会转为数组处理</span>
    <span class="token punctuation">;</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>imports<span class="token punctuation">)</span> <span class="token operator">?</span> imports <span class="token operator">:</span> <span class="token punctuation">[</span>imports<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">imp</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      _imports<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>imp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>injectRootOptions</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * Add options to the root Vue instance (detected by `new Vue`).
   */</span>
  <span class="token function">injectRootOptions</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _options <span class="token operator">=</span> <span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>rootOptions<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>rootOptions<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 支持数组，处理同上</span>
    <span class="token punctuation">;</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token operator">?</span> options <span class="token operator">:</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">opt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      _options<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>injectRootOptions</code> 执行后，store 会加入到下面的代码中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  router<span class="token punctuation">,</span>
  store<span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>extendPackage</code> 方法是用来扩展项目的 package.json 文件，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
   * 扩展项目的 package.json 文件
   * 也解决不同插件之间的依赖冲突
   * 工具配置字段可能在提取之前被提取到独立文件中
   * 文件将写入磁盘
   *
   * @param {object | () =&gt; object} fields - 合并的字段
   * @param {object} [options] - 用来扩展/合并的选项
   * @param {boolean} [options.prune=false] - 在合并之后从对象中移除所有 null/undefined 字段
   * @param {boolean} [options.merge=true] 深度合并嵌套字段
   *    无论次选项如何依赖字段始终会深度合并
   * @param {boolean} [options.warnIncompatibleVersions=true] 如果依赖版本没有相交，将输出警告
   */</span>
  <span class="token function">extendPackage</span> <span class="token punctuation">(</span><span class="token parameter">fields<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> extendOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
      prune<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      merge<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      warnIncompatibleVersions<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这是为了兼容性</span>
    <span class="token comment">// 版本 4.0.0 到 4.1.2, 没有 `options` 对象, 只有 `forceNewVersion` 标志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">'boolean'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      extendOptions<span class="token punctuation">.</span>warnIncompatibleVersions <span class="token operator">=</span> <span class="token operator">!</span>options
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>extendOptions<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>pkg
    <span class="token comment">// 我们传入的是个对象，所以这里走 else 选项</span>
    <span class="token keyword">const</span> toMerge <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">fields</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span> <span class="token operator">:</span> fields
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> toMerge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// value = { vuex: '^3.1.2' }</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> toMerge<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// existing = { xxx } 现有依赖</span>
      <span class="token keyword">const</span> existing <span class="token operator">=</span> pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// key = dependencies</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'dependencies'</span> <span class="token operator">||</span> key <span class="token operator">===</span> <span class="token string">'devDependencies'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用特定版本解决冲突</span>
        pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mergeDeps</span><span class="token punctuation">(</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
          existing <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          value<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>depSources<span class="token punctuation">,</span>
          extendOptions
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>extendOptions<span class="token punctuation">.</span>merge <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> pkg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mergeArrayWithDedupe</span><span class="token punctuation">(</span>existing<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isObject</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepmerge</span><span class="token punctuation">(</span>existing<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">{</span> arrayMerge<span class="token operator">:</span> mergeArrayWithDedupe <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>extendOptions<span class="token punctuation">.</span>prune<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">pruneObject</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>再看 <code>api.render('./template', {})</code> 这句话，我们找到 GeneratorAPI 对应的 <code>render</code> 方法：</p> <p>因为我们第一个参数是字符串类型，所以这里仅截取了部分走的到的逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * Render template files into the virtual files tree object.
   * 渲染模板文件到虚拟文件树对象
   * @param {string | object | FileMiddleware} source -
   *   参数可以是下面几种
   *   - 相对路径；
   *   - { 模板源：目标文件 } 的哈希对象映射；
   *   - 自定义的文件中间件函数
   * @param {object} [additionalData] - 模板能够获得的额外数据
   * @param {object} [ejsOptions] - ejs 的配置信息
   */</span>
  <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> additionalData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ejsOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> baseDir <span class="token operator">=</span> <span class="token function">extractCallDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      source <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">,</span> source<span class="token punctuation">)</span>
      <span class="token comment">// 这里传入 _injectFileMiddleware 的函数是个参数，所以并不会马上执行</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_injectFileMiddleware</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resolveData</span><span class="token punctuation">(</span>additionalData<span class="token punctuation">)</span>
        <span class="token keyword">const</span> globby <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'globby'</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> _files <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">globby</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'**/*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> source <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> rawPath <span class="token keyword">of</span> _files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> targetPath <span class="token operator">=</span> rawPath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">filename</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 以点开头的文件当发布到 npm 上会被忽略，所以在模板中我们需要用下划线取代（例如，&quot;_gitignore&quot;）</span>
            <span class="token comment">// 这里则是将 下划线 转回 点</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'_'</span> <span class="token operator">&amp;&amp;</span> filename<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'_'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 对于两个下划线的文件名，则截取第二个下划线开始的字符串名字</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'_'</span> <span class="token operator">&amp;&amp;</span> filename<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'_'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filename<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> filename
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> sourcePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> rawPath<span class="token punctuation">)</span>
          <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderFile</span><span class="token punctuation">(</span>sourcePath<span class="token punctuation">,</span> data<span class="token punctuation">,</span> ejsOptions<span class="token punctuation">)</span>
          <span class="token comment">// 对于二进制文件或者非空白的文件才设置，否则就过滤了</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\s]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            files<span class="token punctuation">[</span>targetPath<span class="token punctuation">]</span> <span class="token operator">=</span> content
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的方法中，调用了 <code>_injectFileMiddleware</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 注入一个文件处理中间件
   *
   * @private 私有的，通过名字的 下划线可以知道
   * @param {FileMiddleware} middleware - 一个中间件函数
   *   他接受虚拟文件树对象，和 ejs 渲染函数。可以是异步的
   */</span>
  <span class="token function">_injectFileMiddleware</span> <span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>fileMiddlewares<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>上面出入 <code>_injectFileMiddleware</code> 的参数，的执行是在 <code>Generator.js</code> 中的 <code>resolveFiles()</code> 方法中</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">async</span> <span class="token function">resolveFiles</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> middleware <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileMiddlewares<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里将 files 传入，作为文件树的根节点</span>
      <span class="token keyword">await</span> <span class="token function">middleware</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> ejs<span class="token punctuation">.</span>render<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token operator">...</span>
</code></pre></div><p>这里我们看下 Typescript 的转换方式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 我们调用的时候传入的仅仅是 GeneratorAPI</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> <span class="token punctuation">{</span> tsLint <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> convertJsToTs <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> jsRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span>
  <span class="token keyword">const</span> excludeRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^tests\/e2e\/|(\.config|rc)\.js$</span><span class="token regex-delimiter">/</span></span>
  <span class="token keyword">const</span> convertLintFlags <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/convertLintFlags'</span><span class="token punctuation">)</span>
  <span class="token comment">// 这里使用了 GeneratorAPI 的 postProcessFiles 方法</span>
  api<span class="token punctuation">.</span><span class="token function">postProcessFiles</span><span class="token punctuation">(</span><span class="token parameter">files</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里默认值是 true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>convertJsToTs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除所有的有同名 ts 文件的 js 文件</span>
      <span class="token comment">// 简单的将其他 js 文件重命名为 ts 文件</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">in</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这个时候我们操作的还是虚拟文件树 files</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jsRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>excludeRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> tsFile <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>jsRE<span class="token punctuation">,</span> <span class="token string">'.ts'</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>files<span class="token punctuation">[</span>tsFile<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> content <span class="token operator">=</span> files<span class="token punctuation">[</span>file<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tsLint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              content <span class="token operator">=</span> <span class="token function">convertLintFlags</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            files<span class="token punctuation">[</span>tsFile<span class="token punctuation">]</span> <span class="token operator">=</span> content
          <span class="token punctuation">}</span>
          <span class="token keyword">delete</span> files<span class="token punctuation">[</span>file<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>这里我们看下 <code>postProcessFiles</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
   * push 一个文件中间件，它将在所有普通中间件都执行完成后再执行
   * @param {FileMiddleware} cb 参数是一个回调函数
   */</span>
  <span class="token function">postProcessFiles</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>postProcessFilesCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>那么 <code>postProcessFilesCbs</code> 将在哪里执行呢，我们再次回到了 <code>Generator.js</code> 文件的 <code>resolveFiles</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 这个我们已经在前面讲到了</span>
  <span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> middleware <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileMiddlewares<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">middleware</span><span class="token punctuation">(</span>files<span class="token punctuation">,</span> ejs<span class="token punctuation">.</span>render<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> postProcess <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postProcessFilesCbs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里我们刚刚 push 进去的 中间件将会执行</span>
    <span class="token keyword">await</span> <span class="token function">postProcess</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>最终的文件写入则在 <code>Generator.js</code> 的 <code>generate</code> 方法中：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">...</span>
  <span class="token comment">// 载入文件树</span>
  <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token comment">// 将虚拟文件树写入磁盘</span>
  <span class="token keyword">await</span> <span class="token function">writeFileTree</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">,</span> initialFiles<span class="token punctuation">)</span>
</code></pre></div><h1 id="vue-cli-plugin-router"><a href="#vue-cli-plugin-router" class="header-anchor">#</a> @vue/cli-plugin-router</h1> <p>这个插件同 <code>@vue/cli-plugin-vuex</code> 也是从 <code>@vue/cli@4.x</code> 开始有的，目的也是规范化 router 的使用，同时添加更完美的默认配置。</p> <h2 id="源码探索-2"><a href="#源码探索-2" class="header-anchor">#</a> 源码探索</h2> <h3 id="service-部分-2"><a href="#service-部分-2" class="header-anchor">#</a> Service 部分</h3> <p>同 <code>@vue/cli-plugin-vuex</code> 一致，因为是必须项，所以也是导出空函数</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="generator-部分-2"><a href="#generator-部分-2" class="header-anchor">#</a> Generator 部分</h3> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 增加入口</span>
  api<span class="token punctuation">.</span><span class="token function">injectImports</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import router from './router'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token comment">// 增加 router 选项</span>
  api<span class="token punctuation">.</span><span class="token function">injectRootOptions</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span>entryFile<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">router</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token comment">// 扩展项目的 package.json 文件中的依赖</span>
  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'vue-router'</span><span class="token operator">:</span> <span class="token string">'^3.1.5'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 渲染模板</span>
  api<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./template'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    historyMode<span class="token operator">:</span> options<span class="token punctuation">.</span>historyMode<span class="token punctuation">,</span>
    doesCompile<span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'babel'</span><span class="token punctuation">)</span> <span class="token operator">||</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    hasTypeScript<span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span>invoking<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* eslint-disable-next-line node/no-extraneous-require */</span>
      <span class="token keyword">const</span> convertFiles <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-plugin-typescript/generator/convert'</span><span class="token punctuation">)</span>
      <span class="token function">convertFiles</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>前面的部分和 <code>@vue/cli-plugin-vuex</code> 是一致的，这里有区别的地方是，render 方法传了参数：</p> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./template'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    historyMode<span class="token operator">:</span> options<span class="token punctuation">.</span>historyMode<span class="token punctuation">,</span>
    doesCompile<span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'babel'</span><span class="token punctuation">)</span> <span class="token operator">||</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    hasTypeScript<span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// additionalData 这个参数就是上面传入的</span>
<span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> additionalData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> ejsOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_injectFileMiddleware</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 传入 _resolveData 方法中</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resolveData</span><span class="token punctuation">(</span>additionalData<span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> rawPath <span class="token keyword">of</span> _files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>
          <span class="token comment">// 处理文件时，作为参数传入</span>
          <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">renderFile</span><span class="token punctuation">(</span>sourcePath<span class="token punctuation">,</span> data<span class="token punctuation">,</span> ejsOptions<span class="token punctuation">)</span>
          <span class="token operator">...</span>
        <span class="token punctuation">}</span>
    <span class="token operator">...</span>
</code></pre></div><p><code>render</code> 方法的第二个参数传入到了 <code>_resolveData</code> 方法中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
   * 渲染模板时解析数据
   *
   * @private
   */</span>
  <span class="token function">_resolveData</span> <span class="token punctuation">(</span><span class="token parameter">additionalData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>
      rootOptions<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rootOptions<span class="token punctuation">,</span>
      plugins<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pluginsData
    <span class="token punctuation">}</span><span class="token punctuation">,</span> additionalData<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 所以最终返回的对象结构如下
    {
      options: {},
      rootOptions: {},
      plugins: {},
      historyMode: '',
      doesCompile: '',
      hasTypeScript: ''
    }
   */</span>
</code></pre></div><p>然后我们看下 <code>renderFile</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">renderFile</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> data<span class="token punctuation">,</span> ejsOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>

  <span class="token comment">// custom template inheritance via yaml front matter.</span>
  <span class="token comment">// ---</span>
  <span class="token comment">// extend: 'source-file'</span>
  <span class="token comment">// replace: !!js/regexp /some-regex/</span>
  <span class="token comment">// OR</span>
  <span class="token comment">// replace:</span>
  <span class="token comment">//   - !!js/regexp /foo/</span>
  <span class="token comment">//   - !!js/regexp /bar/</span>
  <span class="token comment">// ---</span>
  <span class="token comment">// https://github.com/dworthen/js-yaml-front-matter</span>
  <span class="token keyword">const</span> yaml <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'yaml-front-matter'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> parsed <span class="token operator">=</span> yaml<span class="token punctuation">.</span><span class="token function">loadFront</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
  <span class="token comment">// content 就是文件内容</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> parsed<span class="token punctuation">.</span>__content
  <span class="token keyword">let</span> finalTemplate <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span>
  
  <span class="token operator">...</span>

  <span class="token comment">// data 最终传到 ejs 的 render 方法中</span>
  <span class="token keyword">return</span> ejs<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>finalTemplate<span class="token punctuation">,</span> data<span class="token punctuation">,</span> ejsOptions<span class="token punctuation">)</span>
</code></pre></div><p><code>ejs.redner()</code> 这个方法的第一个参数，是模板，第二个参数是传入模板中的变量，第三个则是ejs模板的配置项。所以我们的 <code>data</code> 会模板渲染的时候使用到，那么我们看下模板中是如何使用的：</p> <p><code>@vue/cli-plugin-router/generator/template/src/App.vue</code>，首先看这个模板文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">--</span><span class="token operator">-</span>
extend<span class="token operator">:</span> <span class="token string">'@vue/cli-service/generator/template/src/App.vue'</span>
replace<span class="token operator">:</span>
  <span class="token operator">-</span> <span class="token operator">!</span><span class="token operator">!</span>js<span class="token operator">/</span>regexp <span class="token operator">/</span><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token operator">^</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">?</span><span class="token operator">&lt;</span>\<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">template&gt;</span><span class="token regex-delimiter">/</span></span>
  <span class="token operator">-</span> <span class="token operator">!</span><span class="token operator">!</span>js<span class="token operator">/</span>regexp <span class="token operator">/</span>\n<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token operator">^</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">?</span><span class="token operator">&lt;</span>\<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">script&gt;\n</span><span class="token regex-delimiter">/</span></span>
  <span class="token operator">-</span> <span class="token operator">!</span><span class="token operator">!</span>js<span class="token operator">/</span>regexp <span class="token operator">/</span>  margin<span class="token operator">-</span>top<span class="token punctuation">[</span><span class="token operator">^</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token operator">?</span><span class="token operator">&lt;</span>\<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">style&gt;</span><span class="token regex-delimiter">/</span></span>
<span class="token operator">--</span><span class="token operator">-</span>
</code></pre></div><p>上面这段是 yaml 语法，首先它继承了 <code>@vue/cli-service/generator/template/src/App.vue</code> 文件（这个是原始的模板），然后替换了3部分内容：</p> <ul><li>首先是模板部分：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">%</span># <span class="token constant">REPLACE</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;nav&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>router<span class="token operator">-</span>link to<span class="token operator">=</span><span class="token string">&quot;/&quot;</span><span class="token operator">&gt;</span>Home<span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>link<span class="token operator">&gt;</span> <span class="token operator">|</span>
      <span class="token operator">&lt;</span>router<span class="token operator">-</span>link to<span class="token operator">=</span><span class="token string">&quot;/about&quot;</span><span class="token operator">&gt;</span>About<span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>link<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>router<span class="token operator">-</span>view<span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">%</span># <span class="token constant">END_REPLACE</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre></div><p>然后 script 脚本，替换为空：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">%</span># <span class="token constant">REPLACE</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">%</span># <span class="token constant">END_REPLACE</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre></div><p>最后是样式部分</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token operator">&lt;</span><span class="token operator">%</span># <span class="token constant">REPLACE</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token comment">// 这里的括号是为了承接继承的内容</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这里可以看到是用到 data 中的 rootOptions 属性</span>
<span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token keyword">if</span> <span class="token punctuation">(</span>rootOptions<span class="token punctuation">.</span>cssPreprocessor <span class="token operator">!==</span> <span class="token string">'stylus'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token operator">...</span>
<span class="token operator">&lt;</span><span class="token operator">%</span># <span class="token constant">END_REPLACE</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre></div><p><code>@vue/cli-plugin-router/generator/template/src/router/index.js</code> 这个文件中用到了通过插件传入过来的参数：<code>hasTypeScript</code>、<code>doesCompile</code>、<code>historyMode</code>：</p> <p>区分 Typescript，使用不同的导入方式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token keyword">if</span> <span class="token punctuation">(</span>hasTypeScript<span class="token punctuation">)</span> <span class="token punctuation">{</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> VueRouter<span class="token punctuation">,</span> <span class="token punctuation">{</span> RouteConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token punctuation">}</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre></div><p>通过 doescCompile，来区分是否需要编译</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token keyword">if</span> <span class="token punctuation">(</span>doesCompile<span class="token punctuation">)</span> <span class="token punctuation">{</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
    <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="token string">'../views/About.vue'</span><span class="token punctuation">)</span>
    <span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
    <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="token string">'../views/About.vue'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token punctuation">}</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
</code></pre></div><p>通过 <code>historyMode</code> 控制路由模式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token keyword">if</span> <span class="token punctuation">(</span>historyMode<span class="token punctuation">)</span> <span class="token punctuation">{</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
  mode<span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
  base<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BASE_URL</span><span class="token punctuation">,</span>
  <span class="token operator">&lt;</span><span class="token operator">%</span>_ <span class="token punctuation">}</span> _<span class="token operator">%</span><span class="token operator">&gt;</span>
  routes
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="prompts-部分"><a href="#prompts-部分" class="header-anchor">#</a> Prompts 部分</h3> <p>对话这里只有一个问题，就是路由类型。这个问题的答案在 <code>historyMode: options.historyMode,</code> 这里就用到了。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'historyMode'</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use history mode for router? </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(Requires proper server setup for index fallback in production)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">By using the HTML5 History API, the URLs don't need the '#' character anymore.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>这里我们看下上面的 <code>prompts</code> 是如何被执行的，我们添加插件是通过 <code>vue add @vue/cli-plugin-router</code> 的方式，然后会执行到 <code>@vue/cli/lib/invoke.js</code> 中的 <code>invoke</code> 方法，我们看下 invoke 方法中处理 prompts 的逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pluginOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里就载入了我们定义在插件中的 对话</span>
    <span class="token keyword">let</span> pluginPrompts <span class="token operator">=</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/prompts</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginPrompts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> pluginPrompts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pluginPrompts <span class="token operator">=</span> <span class="token function">pluginPrompts</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> pluginPrompts<span class="token punctuation">.</span>getPrompts <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pluginPrompts <span class="token operator">=</span> pluginPrompts<span class="token punctuation">.</span><span class="token function">getPrompts</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 因为我们的插件中返回的是数组，所有就直接执行了（开始对话）</span>
      pluginOptions <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span>pluginPrompts<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h1 id="vue-cli-plugin-babel"><a href="#vue-cli-plugin-babel" class="header-anchor">#</a> @vue/cli-plugin-babel</h1> <p>babel 用来做语法转换</p> <h2 id="service"><a href="#service" class="header-anchor">#</a> Service</h2> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是 生产环境 并且 开启了 parallel（并行打包）则为 true</span>
  <span class="token keyword">const</span> useThreads <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>parallel
  <span class="token keyword">const</span> cliServicePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-service'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 载入需要额外使用 babel-loader 进行转化的目录</span>
  <span class="token keyword">const</span> transpileDepRegex <span class="token operator">=</span> <span class="token function">genTranspileDepRegex</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>transpileDependencies<span class="token punctuation">)</span>

  <span class="token comment">// try to load the project babel config;</span>
  <span class="token comment">// if the default preset is used,</span>
  <span class="token comment">// there will be a VUE_CLI_TRANSPILE_BABEL_RUNTIME env var set.</span>
  <span class="token comment">// the `filename` field is required</span>
  <span class="token comment">// in case there're filename-related options like `ignore` in the user config</span>
  babel<span class="token punctuation">.</span><span class="token function">loadPartialConfigSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filename<span class="token operator">:</span> api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/main.js'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  api<span class="token punctuation">.</span><span class="token function">chainWebpack</span><span class="token punctuation">(</span><span class="token parameter">webpackConfig</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    webpackConfig<span class="token punctuation">.</span>resolveLoader<span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> jsRule <span class="token operator">=</span> webpackConfig<span class="token punctuation">.</span>module
      <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token string">'js'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.m?jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>exclude
          <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">filepath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 总是转译 vue 文件中的 js 文件</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.vue\.jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 排除了 cli-service 中的动态入口</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>cliServicePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 仅仅当 @vue/babel-preset-app 预设使用时，引入 @babel/runtime</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
              process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TRANSPILE_BABEL_RUNTIME</span> <span class="token operator">&amp;&amp;</span>
              filepath<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'@babel'</span><span class="token punctuation">,</span> <span class="token string">'runtime'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// check if this is something the user explicitly wants to transpile</span>
            <span class="token comment">// 查看用户配置的需要转译的文件不能排除</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transpileDepRegex <span class="token operator">&amp;&amp;</span> transpileDepRegex<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 不转译 node_modules 下的文件</span>
            <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'cache-loader'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'cache-loader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token comment">// api.genCacheConfig 这个方法我们看下</span>
          <span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">genCacheConfig</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token string">'@babel/core'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
            <span class="token string">'@vue/babel-preset-app'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/babel-preset-app/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
            <span class="token string">'babel-loader'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babel-loader/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
            modern<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_MODERN_BUILD</span><span class="token punctuation">,</span>
            browserslist<span class="token operator">:</span> api<span class="token punctuation">.</span>service<span class="token punctuation">.</span>pkg<span class="token punctuation">.</span>browserslist
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
            <span class="token string">'babel.config.js'</span><span class="token punctuation">,</span>
            <span class="token string">'.browserslistrc'</span>
          <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果使用并行处理，则使用 thread-loader      </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>useThreads<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> threadLoaderConfig <span class="token operator">=</span> jsRule
        <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'thread-loader'</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'thread-loader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>parallel <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        threadLoaderConfig<span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">{</span> workers<span class="token operator">:</span> options<span class="token punctuation">.</span>parallel <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 重点，应用babel-loader</span>
    jsRule
      <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">loader</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>@vue/cli-service/lib/PluginAPI.js</code>，我们看下 <code>genCacheConfig</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * 通过大量的变量生成一个缓存标志
   */</span>
  <span class="token comment">// 根据前面的调用 id = babel-laoder</span>
  <span class="token comment">// partialIdentifier = { '@babel/core': 'x.x.x', '@vue/babel-preset-app': 'x.x.x', 'babel-loader': 'x.x.x' }</span>
  <span class="token comment">// configFiles = ['babel.config.js', '.browserslistrc']</span>
  <span class="token function">genCacheConfig</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> partialIdentifier<span class="token punctuation">,</span> configFiles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
    <span class="token comment">// 这里可以看到 缓存目录是 项目的 node_modules/.cache/</span>
    <span class="token keyword">const</span> cacheDirectory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules/.cache/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token comment">// 这是所有版本相关的变量集合</span>
    <span class="token keyword">const</span> variables <span class="token operator">=</span> <span class="token punctuation">{</span>
      partialIdentifier<span class="token punctuation">,</span>
      <span class="token string">'cli-service'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
      <span class="token string">'cache-loader'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cache-loader/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
      env<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">,</span>
      test<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_CLI_TEST</span><span class="token punctuation">,</span>
      config<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token function">fmtFunc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>chainWebpack<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">fmtFunc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>projectOptions<span class="token punctuation">.</span>configureWebpack<span class="token punctuation">)</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 所有的配置文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>configFiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      configFiles <span class="token operator">=</span> <span class="token punctuation">[</span>configFiles<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    configFiles <span class="token operator">=</span> configFiles<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token string">'package-lock.json'</span><span class="token punctuation">,</span>
      <span class="token string">'yarn.lock'</span><span class="token punctuation">,</span>
      <span class="token string">'pnpm-lock.yaml'</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// 将配置文件也添加到 variables 变量上，保证唯一</span>
    variables<span class="token punctuation">.</span>configFiles <span class="token operator">=</span> configFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">readConfig</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
      <span class="token keyword">return</span> content <span class="token operator">&amp;&amp;</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\r\n?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 这里使用了 hash-sum 哈希生成器来生成唯一标志</span>
    <span class="token keyword">const</span> cacheIdentifier <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>variables<span class="token punctuation">)</span>
    <span class="token comment">// 返回的对象，则是 cache-loader 需要的配置</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> cacheDirectory<span class="token punctuation">,</span> cacheIdentifier <span class="token punctuation">}</span>
</code></pre></div><h2 id="generator"><a href="#generator" class="header-anchor">#</a> Generator</h2> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">api</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 你很可能希望覆盖整个配置以确保他没有冲突的正常工作，例如，对于一个使用了 Jest 但是没有使用 Babel 的项目。</span>
  <span class="token comment">// 它对于使用自己的特殊 babel 配置而没有使用 Babel 插件已有的配置很少见。</span>
  <span class="token keyword">delete</span> api<span class="token punctuation">.</span>generator<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'babel.config.js'</span><span class="token punctuation">]</span>


  <span class="token comment">// 这里修改 package.json 文件中的 babel 配置项；增加了 core.js@3 的依赖。</span>
  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    babel<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 我们看到 presets 来自 @vue/cli-plugin-babel/preset</span>
      presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@vue/cli-plugin-babel/preset'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'core-js'</span><span class="token operator">:</span> <span class="token string">'^3.6.4'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们就再看下 <code>@vue/cli-plugin-babel/preset</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/babel-preset-app'</span><span class="token punctuation">)</span>
</code></pre></div><p>这里就一句引用，内容来自 <code>@vue/babel-preset-app</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    sourceType<span class="token operator">:</span> <span class="token string">'unambiguous'</span><span class="token punctuation">,</span>
    overrides<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      exclude<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">@babel[\/|\\\\]runtime</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">core-js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      presets<span class="token punctuation">,</span>
      plugins
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// there are some untranspiled code in @babel/runtime</span>
      <span class="token comment">// https://github.com/babel/babel/issues/9903</span>
      include<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">@babel[\/|\\\\]runtime</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      presets<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          useBuiltIns<span class="token punctuation">,</span>
          corejs<span class="token operator">:</span> useBuiltIns <span class="token operator">?</span> <span class="token number">3</span> <span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>@vue/babel-preset-app</code> 经过处理之后导出的 presets 最终赋值给了 <code>package.json</code> 文件中 <code>babel.presets</code> 选项，至于其中的细节，我们将其放在 Babel 的后续分析中。</p> <p>这里有一点需要注意的地方，虽然我们这里看到 <code>babel.presets</code> 的配置应该在 <code>package.json</code> 文件中，那么为啥有的项目并不是这样呢，这里要看下这个 prompt：</p> <p><a href="https://github.com/llccing-demo/vue-cli/blob/773f8a47e9acd58abbd3a3821a906be550b4c010/packages/@vue/cli/lib/Creator.js#L421" target="_blank" rel="noopener noreferrer">useConfigFiles<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'useConfigFiles'</span><span class="token punctuation">,</span>
  when<span class="token operator">:</span> isManualMode<span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
  <span class="token comment">//  Babel, ESLint 等等这些配置文件放在哪里？</span>
  message<span class="token operator">:</span> <span class="token string">'Where do you prefer placing config for Babel, ESLint, etc.?'</span><span class="token punctuation">,</span>
  choices<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 放在专用的配置文件中</span>
      name<span class="token operator">:</span> <span class="token string">'In dedicated config files'</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">'files'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 放在 package.json 中</span>
      name<span class="token operator">:</span> <span class="token string">'In package.json'</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">'pkg'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个 prompt 的结果决定了配置文件放的位置，如果你这里的 <code>useConfigFiles</code> 选择 <code>In dedicated config files</code>，那么 再看<a href="https://github.com/llccing-demo/vue-cli/blob/773f8a47e9acd58abbd3a3821a906be550b4c010/packages/@vue/cli/lib/Creator.js#L195" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在 Creator 的 create 方法中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> generator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  extractConfigFiles<span class="token operator">:</span> preset<span class="token punctuation">.</span>useConfigFiles
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里将用户的选择传入了 <code>generator.generate</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
<span class="token comment">// extract configs from package.json into dedicated files.</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">extractConfigFiles</span><span class="token punctuation">(</span>extractConfigFiles<span class="token punctuation">,</span> checkExisting<span class="token punctuation">)</span>
</code></pre></div><p>这里我们看下 <code>extractConfigFiles</code> 方法的主要逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">extractConfigFiles</span> <span class="token punctuation">(</span><span class="token parameter">extractAll<span class="token punctuation">,</span> checkExisting</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token comment">// 这里定义了一个提取方法</span>
    <span class="token keyword">const</span> <span class="token function-variable function">extract</span> <span class="token operator">=</span> <span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        configTransforms<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// do not extract if the field exists in original package.json</span>
        <span class="token comment">// 如果 字段 存在于原始的 package.json 文件中，则不提取</span>
        <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>originalPkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">const</span> configTransform <span class="token operator">=</span> configTransforms<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> configTransform<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>
          value<span class="token punctuation">,</span>
          checkExisting<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>context
        <span class="token punctuation">)</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> content<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> res
        <span class="token comment">// 因为操作的都是虚拟文件树，所以这里相当于创建单独的配置文件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ensureEOL</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
        <span class="token comment">// 这里删除提取的字段</span>
        <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>extractAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里会循环 package.json 下的每一个字段，看是否需要提取</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">extract</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="migrator"><a href="#migrator" class="header-anchor">#</a> migrator</h2> <p>这个工具主要是为了更加方便的升级，在前面讲 <code>vue upgrade</code> 命令时我们已经提到了<a href="https://llccing.github.io/FrontEnd/lib/vue-cli/14-cli-upgrade.html" target="_blank" rel="noopener noreferrer">他是如何被调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的。</p> <p>我们来看下 <code>@vue/cli-plugin-babel</code> 的 migrator 的内部逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">api</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这句话是个深坑，来，我们往里跳!</span>
  api<span class="token punctuation">.</span><span class="token function">transformScript</span><span class="token punctuation">(</span>
    <span class="token string">'babel.config.js'</span><span class="token punctuation">,</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../codemods/usePluginPreset'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// 这里判断若是从 3.x 的版本升级，则增加 `core.js` 的依赖项</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">fromVersion</span><span class="token punctuation">(</span><span class="token string">'^3'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">'core-js'</span><span class="token operator">:</span> <span class="token string">'^3.6.4'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> warnIncompatibleVersions<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    <span class="token comment">// TODO: implement a codemod to migrate polyfills</span>
    <span class="token comment">// 这里是作者留下的待实现的内容，可以看到是计划在增加 migrator 增加自动化迁移</span>
    api<span class="token punctuation">.</span><span class="token function">exitLog</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">core-js has been upgraded from v2 to v3.
If you have any custom polyfills defined in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token string">'babel.config.js'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, please be aware their names may have been changed.
For more complete changelog, see https://github.com/zloirock/core-js/blob/master/CHANGELOG.md#300---20190319</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>api.transformScript</code> 这个方法是 <code>MigratorAPI</code> 继承自 <code>GeneratorAPI</code>，这里我们看下逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
   * 针对 script 脚本 或者 .vue 文件中 script 部分执行 codemod
   * @param {string} file the path to the file to transform
   * @param {Codemod} codemod the codemod module to run
   * @param {object} options additional options for the codemod
   */</span>
  <span class="token function">transformScript</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> codemod<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_injectFileMiddleware</span><span class="token punctuation">(</span><span class="token parameter">files</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里调用了 runCodemod 方法</span>
      files<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">runCodemod</span><span class="token punctuation">(</span>
        codemod<span class="token punctuation">,</span>
        <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">,</span> source<span class="token operator">:</span> files<span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        options
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>顺藤摸瓜我们再看下 <code>runCodemod</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里因引入了两个重要插件</span>
<span class="token keyword">const</span> adapt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-jscodeshift-adapter'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> jscodeshift <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jscodeshift'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">runCodemod</span> <span class="token punctuation">(</span><span class="token parameter">transformModule<span class="token punctuation">,</span> fileInfo<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jscodeshift <span class="token operator">=</span> jscodeshift<span class="token punctuation">.</span><span class="token function">withParser</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">adapt</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">,</span> api<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里是借助了 <a href="https://github.com/facebook/jscodeshift" target="_blank" rel="noopener noreferrer">jscodeshift<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来处理js文件内容。</p> <p>我们看下 <code>require('../codemods/usePluginPreset')</code> 这里是如何处理js文件的：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 这里都是在进行内容的替换</span>
  root
    <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>Literal<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'@vue/app'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-plugin-babel/preset'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  root
    <span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>Literal<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'@vue/babel-preset-app'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-plugin-babel/preset'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>可以看到主要是替换某些关键词，这里的具体的语法我们暂时不深究，只需知道他是做了内容替换即可。</p> <p>至此，<code>@vue/cli-plugin-babel</code>的解析也就结束了。</p> <h1 id="vue-cli-plugin-typescirpt"><a href="#vue-cli-plugin-typescirpt" class="header-anchor">#</a> @vue/cli-plugin-typescirpt</h1> <p>对于这个插件的基本内容，可以看下我<a href="https://llccing.github.io/FrontEnd/blog/translate/vue-cli-plugin-typescript-readme.html" target="_blank" rel="noopener noreferrer">翻译的 README<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，相信这样你应该对这个插件有个基本的了解了。</p> <h2 id="service-2"><a href="#service-2" class="header-anchor">#</a> Service</h2> <p>Service 的内容大部分和 <code>@vue/cli-plugin-babel</code> 的内容重复，不赘述，几个不一样的地方：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里判断如果不是多页应用，则进行以下处理</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>projectOptions<span class="token punctuation">.</span>pages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'./src/main.ts'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里的 projectOptions 是<a href="https://github.com/llccing-demo/vue-cli/blob/e9fd9a716cb0ad856e842f76d3d69e5ff29ae9c0/packages/@vue/cli-service/lib/options.js#L81" target="_blank" rel="noopener noreferrer">项目默认配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> + <code>vue.config.js</code> 两部分内容合并起来的。</p> <p><strong>执行时机</strong>，不知道你会不会有这样的疑问，那么这个 Service 插件到底是什么时候执行的呢。其实我们<a href="https://llccing.github.io/FrontEnd/lib/vue-cli/20-plugin.html#%E5%AE%89%E8%A3%85%E5%B9%B6%E6%89%A7%E8%A1%8C%E6%8F%92%E4%BB%B6" target="_blank" rel="noopener noreferrer">前面也提到过<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，比如我们调试项目时，会执行 <code>yarn serve</code> 那么其实是执行了 <code>vue-cli-service serve</code>，所以在这个时机，如果我们安装 <code>@vue/cli-plugin-typescript</code> 插件，那么它的 Service 部分则会执行。</p> <p>还有个之前没有碰到的写法是，这里注册了新的命令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 判断如果没有安装 eslint 插件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>api<span class="token punctuation">.</span><span class="token function">hasPlugin</span><span class="token punctuation">(</span><span class="token string">'eslint'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 注册 lint 命令</span>
  api<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span><span class="token string">'lint'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    description<span class="token operator">:</span> <span class="token string">'lint source files with TSLint'</span><span class="token punctuation">,</span>
    usage<span class="token operator">:</span> <span class="token string">'vue-cli-service lint [options] [...files]'</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'--format [formatter]'</span><span class="token operator">:</span> <span class="token string">'specify formatter (default: codeFrame)'</span><span class="token punctuation">,</span>
      <span class="token string">'--no-fix'</span><span class="token operator">:</span> <span class="token string">'do not fix errors'</span><span class="token punctuation">,</span>
      <span class="token string">'--formatters-dir [dir]'</span><span class="token operator">:</span> <span class="token string">'formatter directory'</span><span class="token punctuation">,</span>
      <span class="token string">'--rules-dir [dir]'</span><span class="token operator">:</span> <span class="token string">'rules directory'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/tslint'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> api<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们看到 lint 命令的处理逻辑在 <code>./lib/tslint</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 可以看到这里用到了 tslint</span>
<span class="token keyword">const</span> tslint <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tslint'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ts <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'typescript'</span><span class="token punctuation">)</span>
<span class="token operator">...</span>

<span class="token comment">// 这里其实有新的发现，vue-template-compiler原来能够解析 vue 文件的部分内容</span>
<span class="token keyword">const</span> vueCompiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-template-compiler'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> script <span class="token punctuation">}</span> <span class="token operator">=</span> vueCompiler<span class="token punctuation">.</span><span class="token function">parseComponent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span> pad<span class="token operator">:</span> <span class="token string">'line'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p><a href="https://github.com/vuejs/vue/tree/dev/packages/vue-template-compiler" target="_blank" rel="noopener noreferrer">vue-template-compiler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这个就是 Vue 中的代码了。</p> <h2 id="prompts"><a href="#prompts" class="header-anchor">#</a> Prompts</h2> <p>这里我们先看下 <code>Prompts</code>，为啥呢，因为 <code>Generator</code> 中的配置信息部分就来自 <code>Prompts</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// these prompts are used if the plugin is late-installed into an existing</span>
<span class="token comment">// project and invoked by `vue invoke`.</span>

<span class="token comment">// 如果这个插件使用 `vue invoke`命令，后安装到一个已经存在的项目中时，这些对话才会被使用。</span>
<span class="token keyword">const</span> prompts <span class="token operator">=</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 是否使用 classComponent</span>
    name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">classComponent</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">confirm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use class-style component syntax?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">useTsWithBabel</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">confirm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'Use Babel alongside TypeScript (required for modern mode, auto-detected polyfills, transpiling JSX)?'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lint</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">confirm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use TSLint?</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lintOn</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">checkbox</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token function-variable function">when</span><span class="token operator">:</span> <span class="token parameter">answers</span> <span class="token operator">=&gt;</span> answers<span class="token punctuation">.</span>lint<span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pick lint features:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    choices<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Lint on save'</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token string">'save'</span><span class="token punctuation">,</span>
        checked<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Lint and fix on commit'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">hasGit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">' (requires Git)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token string">'commit'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 将 js 转换为 ts</span>
    name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">convertJsToTs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">confirm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Convert all .js files to .ts?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">allowJs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">confirm</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Allow .js files to be compiled?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>默认的 typescript 对话<a href="https://github.com/llccing-demo/vue-cli/blob/82dbbeb07a02a7212d9f9c0019f49436ba77dc70/packages/@vue/cli/lib/promptModules/typescript.js#L1" target="_blank" rel="noopener noreferrer">在这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="generator-2"><a href="#generator-2" class="header-anchor">#</a> Generator</h2> <p>了解了 <code>Prompts</code> 后，再看 <code>Generator</code> 就会清晰一些，基本的内容和前面一致，不赘述，看下新的东西：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里将插件自身的 `package.json` 文件引入了</span>
<span class="token keyword">const</span> pluginDevDeps <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>devDependencies

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  classComponent<span class="token punctuation">,</span>
  tsLint<span class="token punctuation">,</span>
  lintOn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  convertJsToTs<span class="token punctuation">,</span>
  allowJs
<span class="token punctuation">}</span><span class="token punctuation">,</span> _<span class="token punctuation">,</span> invoking</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    devDependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里使用插件的 typescript 版本来作为安装依赖的版本</span>
      <span class="token comment">// 达到了维护一致性的目的</span>
      <span class="token comment">// 不用同时分别维护插件 `package.json` 的版本和此处的版本</span>
      typescript<span class="token operator">:</span> pluginDevDeps<span class="token punctuation">.</span>typescript
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token operator">...</span>
  <span class="token comment">// 在创建完成后 执行 lint 修复文件</span>
  api<span class="token punctuation">.</span><span class="token function">onCreateComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/tslint'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> api<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token operator">...</span>
  <span class="token comment">// 这里执行转换</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./convert'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span> tsLint<span class="token punctuation">,</span> convertJsToTs <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里看下 <code>onCreateComplete</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * push 一个当文件被写入磁盘之后才会调用的回调函数。
   *
   * @param {function} cb
   */</span>
  <span class="token function">onCreateComplete</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">afterInvoke</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">afterInvoke</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>afterInvokeCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>所以 <code>onCreateComplete</code> 其实是 push 了一个回调函数，待之后执行。</p> <p>然后再看下 <code>require('./convert')</code> 这里的 <code>convert</code> 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code>api<span class="token punctuation">.</span><span class="token function">postProcessFiles</span><span class="token punctuation">(</span><span class="token parameter">files</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>convertJsToTs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 删除所有有同名 ts 文件的js文件，然后简单的将其他 js 文件重命名为 ts 文件</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// rename only main file to main.ts</span>
      <span class="token comment">// 仅仅重命名 main.js 为 main.ts</span>
      <span class="token keyword">const</span> tsFile <span class="token operator">=</span> api<span class="token punctuation">.</span>entryFile<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>jsRE<span class="token punctuation">,</span> <span class="token string">'.ts'</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> content <span class="token operator">=</span> files<span class="token punctuation">[</span>api<span class="token punctuation">.</span>entryFile<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tsLint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这个函数的逻辑在下面解析</span>
        content <span class="token operator">=</span> <span class="token function">convertLintFlags</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      files<span class="token punctuation">[</span>tsFile<span class="token punctuation">]</span> <span class="token operator">=</span> content
      <span class="token keyword">delete</span> files<span class="token punctuation">[</span>api<span class="token punctuation">.</span>entryFile<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后了解下 <code>api.postProcessFiles</code> 方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">/**
   * push 一个文件中间件 -- 它将在所有普通文件中间件执行后再执行
   *
   * @param {FileMiddleware} cb
   */</span>
  <span class="token function">postProcessFiles</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>generator<span class="token punctuation">.</span>postProcessFilesCbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><code>convertLintFlags</code> 这个方法我们也看下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">convertLintFlags</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> file
    <span class="token comment">// 主要是将 eslint 的规则，转成 tslint 的规则</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/\*\s?eslint-(enable|disable)([^*]+)?\*\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> $<span class="token number">1</span><span class="token punctuation">,</span> $<span class="token number">2</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token number">2</span><span class="token punctuation">)</span> $<span class="token number">2</span> <span class="token operator">=</span> $<span class="token number">2.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* tslint:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">2</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">2</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> */</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/\/\s?eslint-disable-(next-)?line(.+)?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> $<span class="token number">1</span><span class="token punctuation">,</span> $<span class="token number">2</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>$<span class="token number">2</span><span class="token punctuation">)</span> $<span class="token number">2</span> <span class="token operator">=</span> $<span class="token number">2.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">// tslint:disable-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">1</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">line</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">2</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>$<span class="token number">2</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时 <code>Generator</code> 中也有模板，模板的写法大量使用了 <a href="https://github.com/dworthen/js-yaml-front-matter" target="_blank" rel="noopener noreferrer">yaml-front-matter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 从字符串或者文件中解析 <a href="https://www.ruanyifeng.com/blog/2016/07/yaml.html" target="_blank" rel="noopener noreferrer">YAML<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来进行继承和替换。</p> <h2 id="migrator-2"><a href="#migrator-2" class="header-anchor">#</a> Migrator</h2> <p>Migrator 中的逻辑很简单：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">api</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个升级的迁移方式，暂时来看升级一下 typescirpt 依赖的版本就可以了。</span>
  api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      devDependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
        typescript<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>devDependencies<span class="token punctuation">.</span>typescript
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> warnIncompatibleVersions<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="vue-cli-plugin-eslint"><a href="#vue-cli-plugin-eslint" class="header-anchor">#</a> @vue/cli-plugin-eslint</h1> <p>对于这个插件的基本内容，可以看下我<a href="https://llccing.github.io/FrontEnd/blog/translate/vue-cli-plugin-eslint-readme.html" target="_blank" rel="noopener noreferrer">翻译的 README<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，相信这样你应该对这个插件有个基本的了解了。</p> <h2 id="service-3"><a href="#service-3" class="header-anchor">#</a> Service</h2> <p>Service 服务中主要是增加 webpack 的配置和 注册了 <code>lint</code> 命令：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>lintOnSave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> extensions <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./eslintOptions'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">extensions</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span>
    <span class="token comment">// 这里使用 loadModule 方法，允许用户自定义 ESLint 依赖版本。</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> resolveModule<span class="token punctuation">,</span> loadModule <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@vue/cli-shared-utils'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> cwd <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">getCwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> eslintPkg <span class="token operator">=</span>
      <span class="token comment">// 这里在下文分析下</span>
      <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token string">'eslint/package.json'</span><span class="token punctuation">,</span> cwd<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token string">'eslint/package.json'</span><span class="token punctuation">,</span> __dirname<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token comment">// eslint-loader 在 eslint 配置改变时不会破会缓存，所以我们需要手动地生成一个缓存标志将配置考虑在内。</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> cacheIdentifier <span class="token punctuation">}</span> <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">genCacheConfig</span><span class="token punctuation">(</span>
      <span class="token string">'eslint-loader'</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token string">'eslint-loader'</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'eslint-loader/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>version<span class="token punctuation">,</span>
        eslint<span class="token operator">:</span> eslintPkg<span class="token punctuation">.</span>version
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token string">'.eslintrc.js'</span><span class="token punctuation">,</span>
        <span class="token string">'.eslintrc.yaml'</span><span class="token punctuation">,</span>
        <span class="token string">'.eslintrc.yml'</span><span class="token punctuation">,</span>
        <span class="token string">'.eslintrc.json'</span><span class="token punctuation">,</span>
        <span class="token string">'.eslintrc'</span><span class="token punctuation">,</span>
        <span class="token string">'package.json'</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token comment">// 接下来是 webpack 的配置部分，暂时省略。</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 这里注册了新的命令 `vue-cli-service lint`</span>
  api<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span>
    <span class="token string">'lint'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      description<span class="token operator">:</span> <span class="token string">'lint and fix source files'</span><span class="token punctuation">,</span>
      usage<span class="token operator">:</span> <span class="token string">'vue-cli-service lint [options] [...files]'</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'--format [formatter]'</span><span class="token operator">:</span> <span class="token string">'specify formatter (default: codeframe)'</span><span class="token punctuation">,</span>
        <span class="token string">'--no-fix'</span><span class="token operator">:</span> <span class="token string">'do not fix errors or warnings'</span><span class="token punctuation">,</span>
        <span class="token string">'--no-fix-warnings'</span><span class="token operator">:</span> <span class="token string">'fix errors, but do not fix warnings'</span><span class="token punctuation">,</span>
        <span class="token string">'--max-errors [limit]'</span><span class="token operator">:</span>
          <span class="token string">'specify number of errors to make build failed (default: 0)'</span><span class="token punctuation">,</span>
        <span class="token string">'--max-warnings [limit]'</span><span class="token operator">:</span>
          <span class="token string">'specify number of warnings to make build failed (default: Infinity)'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      details<span class="token operator">:</span>
        <span class="token string">'For more options, see https://eslint.org/docs/user-guide/command-line-interface#options'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token parameter">args</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lint'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> api<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
</code></pre></div><p>这里看下如果实现了 eslint 自定义和预置同时存在的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cwd <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">getCwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> eslintPkg <span class="token operator">=</span> 
  <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token string">'eslint/package.json'</span><span class="token punctuation">,</span> cwd<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">||</span>
  <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token string">'eslint/package.json'</span><span class="token punctuation">,</span> __dirname<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>再看下 <code>api.getCwd()</code> <a href="https://github.com/llccing-demo/vue-cli/blob/d11ecc2151b3e05a6d5cc0e57ad2452909b71d3a/packages/@vue/cli-service/lib/PluginAPI.js#L45" target="_blank" rel="noopener noreferrer">这个方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/**
   * 当前工作目录（其实也就是项目目录，因为 Service 脚本执行是在项目根目录）
   */</span>
  <span class="token function">getCwd</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>context
  <span class="token punctuation">}</span>
</code></pre></div><p>loadModule 的区别主要是第二个参数不同，这里有个关于 <a href="https://stackoverflow.com/questions/9874382/whats-the-difference-between-process-cwd-vs-dirname" target="_blank" rel="noopener noreferrer">__dirname 和 process.cwd() 区别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的文档可以看下，所以这里会先在 项目目录下找用户定义的 ESLint 如果没有找到的情况下，再在 &quot;源代码所在目录&quot; -- 也就是 <code>@vue/cli-plugin-eslint</code> 这个插件中的 eslint。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> cacheIdentifier <span class="token punctuation">}</span> <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">genCacheConfig</span><span class="token punctuation">(</span>
  <span class="token operator">...</span>
</code></pre></div><p>缓存标志的生成和我们在 <a href="https://llccing.github.io/FrontEnd/lib/vue-cli/23-plugin-babel.html#service" target="_blank" rel="noopener noreferrer"><code>@vue/cli-plugin-babel</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的 Service 部分生成标志用的同一个方法。</p> <p>关于命令注册，它是引用了 <code>lint.js</code>，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">...</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lint'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> api<span class="token punctuation">)</span>
</code></pre></div><p>再看先 <code>lint.js</code> 中部分内容：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 这里可以看到，还是兼容前面提到用户自定义 eslint 的原则</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> CLIEngine <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">loadModule</span><span class="token punctuation">(</span><span class="token string">'eslint'</span><span class="token punctuation">,</span> cwd<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'eslint'</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token comment">// 这里进行了 eslint 的初始化</span>
  <span class="token keyword">const</span> engine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CLIEngine</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token comment">// 这里应该是进行了 lint 操作</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">executeOnFiles</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token comment">// 控制自动修复的逻辑</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>fix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CLIEngine<span class="token punctuation">.</span><span class="token function">outputFixes</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>到此，主要的 Service 逻辑我们就过了一遍。</p> <h2 id="pormpts"><a href="#pormpts" class="header-anchor">#</a> Pormpts</h2> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'config'</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pick an ESLint config:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    choices<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Error prevention only'</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token string">'base'</span><span class="token punctuation">,</span>
        short<span class="token operator">:</span> <span class="token string">'Basic'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'lintOn'</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'checkbox'</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">'Pick additional lint features:'</span><span class="token punctuation">,</span>
    choices<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Lint on save'</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token string">'save'</span><span class="token punctuation">,</span>
        checked<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'Lint and fix on commit'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">hasGit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">' (requires Git)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token string">'commit'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>对话一共两个，第一个是选择一种 ESLint 配置，第二个是选择 lint 的执行时机，默认是在文件保存的时候执行 lint。</p> <h2 id="generator-3"><a href="#generator-3" class="header-anchor">#</a> Generator</h2> <p>直接看代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这里的 config、lintOn 参数，其实就是 对话中的两个问题</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token punctuation">,</span> <span class="token punctuation">{</span> config<span class="token punctuation">,</span> lintOn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> _<span class="token punctuation">,</span> invoking</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里载入了默认的 eslint 配置</span>
  <span class="token keyword">const</span> eslintConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../eslintOptions'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
  <span class="token comment">// 这里的依赖是根据 config 选项决定的，不同的 eslint 规则对应不同的依赖</span>
  <span class="token keyword">const</span> devDependencies <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../eslintDeps'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeps</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> config<span class="token punctuation">)</span>

  <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token punctuation">{</span>
    scripts<span class="token operator">:</span> <span class="token punctuation">{</span>
      lint<span class="token operator">:</span> <span class="token string">'vue-cli-service lint'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    eslintConfig<span class="token punctuation">,</span>
    devDependencies
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>

  <span class="token comment">// lint &amp; fix after create to ensure files adhere to chosen config</span>
  <span class="token comment">// for older versions that do not support the `hooks` feature</span>
  <span class="token comment">// lint 和 修复了 vue-cli 老版本不支持 `hooks` 功能</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里的这个写法，对于我们自己做版本处理相关，也很有用</span>
    api<span class="token punctuation">.</span><span class="token function">assertCliVersion</span><span class="token punctuation">(</span><span class="token string">'^4.0.0-beta.0'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">&amp;&amp;</span> config <span class="token operator">!==</span> <span class="token string">'base'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      api<span class="token punctuation">.</span><span class="token function">onCreateComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lint'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> silent<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> api<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="migrator-3"><a href="#migrator-3" class="header-anchor">#</a> Migrator</h2> <p>这里来看下 eslint 插件升级的逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">api</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 首先获取项目的 package.json 文件</span>
  <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 取得本地 eslint 版本</span>
  <span class="token keyword">let</span> localESLintRange <span class="token operator">=</span> pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">.</span>eslint

  <span class="token comment">// 如果项目是通过 Vue CLI 3.0 或者更早版本构建的，ESLint 依赖（ESLint v4）将在 @vue/cli-plugin-eslint 插件内部；</span>
  <span class="token comment">// 在 Vue CLI v4 中他应该被提取到项目依赖中</span>
  <span class="token comment">// 这里判断如果项目当前 Vue CLI 是3.x版本，并且项目没有单独安装 ESLint 时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>api<span class="token punctuation">.</span><span class="token function">fromVersion</span><span class="token punctuation">(</span><span class="token string">'^3'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>localESLintRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    localESLintRange <span class="token operator">=</span> <span class="token string">'^4.19.1'</span>
    <span class="token comment">// 这里 针对你从 增加了相应的依赖</span>
    api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      devDependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
        eslint<span class="token operator">:</span> localESLintRange<span class="token punctuation">,</span>
        <span class="token string">'babel-eslint'</span><span class="token operator">:</span> <span class="token string">'^8.2.5'</span><span class="token punctuation">,</span>
        <span class="token string">'eslint-plugin-vue'</span><span class="token operator">:</span> <span class="token string">'^4.5.0'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 这里获得 eslint 的主版本号</span>
  <span class="token keyword">const</span> localESLintMajor <span class="token operator">=</span> semver<span class="token punctuation">.</span><span class="token function">major</span><span class="token punctuation">(</span>
    semver<span class="token punctuation">.</span><span class="token function">maxSatisfying</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span><span class="token string">'4.99.0'</span><span class="token punctuation">,</span> <span class="token string">'5.99.0'</span><span class="token punctuation">,</span> <span class="token string">'6.99.0'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      localESLintRange
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// 如果 主版本 已经是 6，说明是最新的，则直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>localESLintMajor <span class="token operator">===</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果 主版本 不是 6，则进行对话</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> confirmUpgrade <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> inquirer<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'confirmUpgrade'</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'confirm'</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Your current ESLint version is v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>localESLintMajor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The lastest major version is v6.\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Do you want to upgrade? (May contain breaking changes)\n</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token comment">// 如果用户的答案是 true</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>confirmUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> getDeps <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../eslintDeps'</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> newDeps <span class="token operator">=</span> <span class="token function">getDeps</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span>
    <span class="token comment">// 这里根据用户已经选择 eslint 规则来设置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">[</span><span class="token string">'@vue/eslint-config-airbnb'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>newDeps<span class="token punctuation">,</span> <span class="token function">getDeps</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token string">'airbnb'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">[</span><span class="token string">'@vue/eslint-config-standard'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>newDeps<span class="token punctuation">,</span> <span class="token function">getDeps</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token string">'standard'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>devDependencies<span class="token punctuation">[</span><span class="token string">'@vue/eslint-config-prettier'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>newDeps<span class="token punctuation">,</span> <span class="token function">getDeps</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token string">'prettier'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    api<span class="token punctuation">.</span><span class="token function">extendPackage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> devDependencies<span class="token operator">:</span> newDeps <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> warnIncompatibleVersions<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="感谢阅读"><a href="#感谢阅读" class="header-anchor">#</a> 感谢阅读</h1> <blockquote><p><a href="https://llccing.github.io/vue-learn-share/vue-cli/" target="_blank" rel="noopener noreferrer">原文地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>感谢你阅读到这里，翻译的不好的地方，还请指点。希望我的内容能让你受用，再次感谢。<a href="https://llccing.github.io/FrontEnd/" target="_blank" rel="noopener noreferrer">by llccing 千里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2021-03-13 11:00:00</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vue-learn-share/assets/js/app.ac9fac58.js" defer></script><script src="/vue-learn-share/assets/js/2.7048fe21.js" defer></script><script src="/vue-learn-share/assets/js/35.97b599d7.js" defer></script>
  </body>
</html>
